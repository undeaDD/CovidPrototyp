!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).firebase)}(this,function(t){"use strict";try{(function(){function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function n(t,e){function n(){this.constructor=t}je(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function r(t,e,n,r){return new(n=n||Promise)(function(i,o){function s(t){try{h(r.next(t))}catch(t){o(t)}}function a(t){try{h(r.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?i(t.value):((e=t.value)instanceof n?e:new n(function(t){t(e)})).then(s,a)}h((r=r.apply(t,e||[])).next())})}function i(t,e){function n(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(o=2&n[0]?i.return:n[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,n[1])).done)return o;switch(i=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){s.label=n[1];break}if(6===n[0]&&s.label<o[1]){s.label=o[1],o=n;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(n);break}o[2]&&s.ops.pop(),s.trys.pop();continue}n=e.call(t,s)}catch(t){n=[6,t],i=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}var r,i,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a}function o(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function a(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(s(arguments[e]));return t}function h(t){for(var e=[],n=0,r=0;r<t.length;r++){var i=t.charCodeAt(r);i<128?e[n++]=i:(i<2048?e[n++]=i>>6|192:(55296==(64512&i)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&t.charCodeAt(++r)),e[n++]=i>>18|240,e[n++]=i>>12&63|128):e[n++]=i>>12|224,e[n++]=i>>6&63|128),e[n++]=63&i|128)}return e}function l(t){try{return Ge.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null}function u(t){return function t(e,n){if(!(n instanceof Object))return n;switch(n.constructor){case Date:var r=n;return new Date(r.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return n}for(var i in n)n.hasOwnProperty(i)&&(e[i]=t(e[i],n[i]));return e}(void 0,t)}function c(){var t=this;this.reject=function(){},this.resolve=function(){},this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n})}function p(){return"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test("undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:"")}function d(){return!0===ze.NODE_ADMIN}function f(t,e,n){return e=Ue.call(this,e)||this,e.code=t,e.customData=n,e.name=$e,Object.setPrototypeOf(e,f.prototype),Error.captureStackTrace&&Error.captureStackTrace(e,Ze.prototype.create),e}function _(t,e,n){this.service=t,this.serviceName=e,this.errors=n}function y(t){return JSON.parse(t)}function g(t){return JSON.stringify(t)}function v(t){var e={},n={},r={},i="";try{var o=t.split(".");e=y(l(o[0])||""),n=y(l(o[1])||""),i=o[2],r=n.d||{};delete n.d}catch(t){}return{header:e,claims:n,data:r,signature:i}}function m(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function C(t,e){return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}function E(t){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function w(t,e,n){var r,i={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&(i[r]=e.call(n,t[r],r,t));return i}function b(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(var t=1;t<this.blockSize;++t)this.pad_[t]=0;this.reset()}function S(t,e,n,r){var i;if(r<e?i="at least "+e:n<r&&(i=0===n?"none":"no more than "+n),i)throw new Error(t+" failed: Was called with "+r+(1===r?" argument.":" arguments.")+" Expects "+i+".")}function T(t,e,n){var r="";switch(e){case 1:r=n?"first":"First";break;case 2:r=n?"second":"Second";break;case 3:r=n?"third":"Third";break;case 4:r=n?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}return t+=" failed: ",t+(r+" argument ")}function I(t,e,n,r){if((!r||n)&&"function"!=typeof n)throw new Error(T(t,e,r)+"must be a valid function.")}function N(t,e,n,r){if((!r||n)&&("object"!=typeof n||null===n))throw new Error(T(t,e,r)+"must be a valid context object.")}function R(t){for(var e=0,n=0;n<t.length;n++){var r=t.charCodeAt(n);r<128?e++:r<2048?e+=2:55296<=r&&r<=56319?(e+=4,n++):e+=3}return e}function P(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function D(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString(),o=yn[e];if(!o)throw new Error("Attempted to log a message with an invalid logType (value: "+e+")");console[o].apply(console,P(["["+i+"]  "+t.name+":"],n))}}function O(t){this.name=t,this._logLevel=_n,this._logHandler=D,this._userLogHandler=null}function x(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY"}function k(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map}function A(t){this.name=t,this.providers=new Map}function F(t){this.domStorage_=t,this.prefix_="firebase:"}function L(){this.cache_={},this.isInMemoryStorage=!0}function M(t){var e=function(t){for(var e=[],n=0,r=0;r<t.length;r++){var i,o=t.charCodeAt(r);55296<=o&&o<=56319&&(i=o-55296,Ke(++r<t.length,"Surrogate pair missing trail surrogate."),o=65536+(i<<10)+(t.charCodeAt(r)-56320)),o<128?e[n++]=o:(o<2048?e[n++]=o>>6|192:(o<65536?e[n++]=o>>12|224:(e[n++]=o>>18|240,e[n++]=o>>12&63|128),e[n++]=o>>6&63|128),e[n++]=63&o|128)}return e}(t);return(t=new en).update(e),t=t.digest(),Ge.encodeByteArray(t)}function W(t,e){Ke(!e||!0===t||!1===t,"Can't turn on custom loggers persistently."),!0===t?(Nn.logLevel=Ve.VERBOSE,Dn=Nn.log.bind(Nn),e&&In.set("logging_enabled",!0)):"function"==typeof t?Dn=t:(Dn=null,In.remove("logging_enabled"))}function Q(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE INTERNAL ERROR: "+Pn.apply(void 0,a(t));Nn.error(n)}function q(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE FATAL ERROR: "+Pn.apply(void 0,a(t));throw Nn.error(n),new Error(n)}function U(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE WARNING: "+Pn.apply(void 0,a(t));Nn.warn(n)}function V(t){return"number"==typeof t&&(t!=t||t===Number.POSITIVE_INFINITY||t===Number.NEGATIVE_INFINITY)}function H(t,e){return t===e?0:t<e?-1:1}function j(t,e){if(e&&t in e)return e[t];throw new Error("Missing required key ("+t+") in object: "+g(e))}function B(t,e){var n=t.length;if(n<=e)return[t];for(var r=[],i=0;i<n;i+=e)n<i+e?r.push(t.substring(i,n)):r.push(t.substring(i,i+e));return r}function z(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n,t[n])}function K(t){var e,n,r,i;Ke(!V(t),"Invalid JSON number"),0===t?e=1/t==-1/(r=n=0)?1:0:(e=t<0,r=(t=Math.abs(t))>=Math.pow(2,-1022)?(n=(i=Math.min(Math.floor(Math.log(t)/Math.LN2),1023))+1023,Math.round(t*Math.pow(2,52-i)-Math.pow(2,52))):(n=0,Math.round(t/Math.pow(2,-1074))));for(var o=[],s=52;s;--s)o.push(r%2?1:0),r=Math.floor(r/2);for(s=11;s;--s)o.push(n%2?1:0),n=Math.floor(n/2);o.push(e?1:0),o.reverse();var a=o.join(""),h="";for(s=0;s<64;s+=8){var l=parseInt(a.substr(s,8),2).toString(16);1===l.length&&(l="0"+l),h+=l}return h.toLowerCase()}function Y(t){try{t()}catch(t){setTimeout(function(){var e=t.stack||"";throw U("Exception was thrown by user callback.",e),t},Math.floor(0))}}function G(t,e){return"object"==typeof(e=setTimeout(t,e))&&e.unref&&e.unref(),e}function X(t,e){if(void 0===e){this.pieces_=t.split("/");for(var n=0,r=0;r<this.pieces_.length;r++)0<this.pieces_[r].length&&(this.pieces_[n]=this.pieces_[r],n++);this.pieces_.length=n,this.pieceNum_=0}else this.pieces_=t,this.pieceNum_=e}function $(t,e){this.errorPrefix_=e,this.parts_=t.slice(),this.byteLength_=Math.max(1,this.parts_.length);for(var n=0;n<this.parts_.length;n++)this.byteLength_+=R(this.parts_[n]);this.checkValid_()}function J(t,e,n,r,i,o,s){void 0===i&&(i=!1),void 0===o&&(o=""),void 0===s&&(s=!1),this.secure=e,this.namespace=n,this.webSocketOnly=r,this.nodeAdmin=i,this.persistenceKey=o,this.includeNamespaceInQueryParams=s,this.host=t.toLowerCase(),this.domain=this.host.substr(this.host.indexOf(".")+1),this.internalHost=Tn.get("host:"+t)||this.host}function Z(t,e){var n=zn(t),r=n.namespace;return"firebase.com"===n.domain&&q(n.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),r&&"undefined"!==r||"localhost"===n.domain||q("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),n.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&U("Insecure Firebase access from a secure page. Please use https in calls to new Firebase()."),t="ws"===n.scheme||"wss"===n.scheme,{repoInfo:new Bn(n.host,n.secure,r,e,t,"",r!==n.subdomain),path:new qn(n.pathString)}}function tt(t){return"string"==typeof t&&0!==t.length&&!Kn.test(t)}function et(t){return"string"==typeof t&&0!==t.length&&!Yn.test(t)}function nt(t){return null===t||"string"==typeof t||"number"==typeof t&&!V(t)||t&&"object"==typeof t&&m(t,".sv")}function rt(t,e,n,r,i){i&&void 0===n||Xn(T(t,e,i),n,r)}function it(t,e,n,r,i){if(!i||void 0!==n){var o=T(t,e,i);if(!n||"object"!=typeof n||Array.isArray(n))throw new Error(o+" must be an object containing the children to replace.");var s=[];z(n,function(t,e){if(t=new qn(t),Xn(o,e,r.child(t)),".priority"===t.getBack()&&!nt(e))throw new Error(o+"contains an invalid value for '"+t.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(t)}),function(t,e){for(var n,r=0;r<e.length;r++)for(var i=(n=e[r]).slice(),o=0;o<i.length;o++)if((".priority"!==i[o]||o!==i.length-1)&&!tt(i[o]))throw new Error(t+"contains an invalid key ("+i[o]+") in path "+n.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');e.sort(qn.comparePaths);var s=null;for(r=0;r<e.length;r++){if(n=e[r],null!==s&&s.contains(n))throw new Error(t+"contains a path "+s.toString()+" that is ancestor of another path "+n.toString());s=n}}(o,s)}}function ot(t,e,n,r){if(!r||void 0!==n){if(V(n))throw new Error(T(t,e,r)+"is "+n.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!nt(n))throw new Error(T(t,e,r)+"must be a valid Firebase priority (a string, finite number, server value, or null).")}}function st(t,e,n,r){if(!r||void 0!==n)switch(n){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(T(t,e,r)+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}function at(t,e,n,r){if(!(r&&void 0===n||tt(n)))throw new Error(T(t,e,r)+'was an invalid key = "'+n+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')}function ht(t,e,n,r){if(!(r&&void 0===n||et(n)))throw new Error(T(t,e,r)+'was an invalid path = "'+n+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')}function lt(t,e){if(".info"===e.getFront())throw new Error(t+" failed = Can't modify data under /.info/")}function ut(t,e,n){var r=n.path.toString();if("string"!=typeof n.repoInfo.host||0===n.repoInfo.host.length||!tt(n.repoInfo.namespace)&&"localhost"!==n.repoInfo.host.split(":")[0]||0!==r.length&&(r=(r=r)&&r.replace(/^\/*\.info(\/|$)/,"/"),!et(r)))throw new Error(T(t,e,!1)+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')}function ct(t,e){this.repo_=t,this.path_=e}function pt(t,e){this.committed=t,this.snapshot=e}function dt(t,e){this.name=t,this.node=e}function ft(){}function _t(){return null!==hn&&hn.apply(this,arguments)||this}function yt(t){return"number"==typeof t?"number:"+K(t):"string:"+t}function gt(t,e){void 0===e&&(e=gt.__childrenNodeConstructor.EMPTY_NODE),this.value_=t,this.priorityNode_=e,this.lazyHash_=null,Ke(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),rr(this.priorityNode_)}function vt(){return null!==dn&&dn.apply(this,arguments)||this}function mt(t,e,n,r,i){void 0===i&&(i=null),this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];for(var o=1;!t.isEmpty();)if(o=e?n(t.key,e):1,r&&(o*=-1),o<0)t=this.isReverse_?t.left:t.right;else{if(0===o){this.nodeStack_.push(t);break}this.nodeStack_.push(t),t=this.isReverse_?t.right:t.left}}function Ct(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:Ct.RED,this.left=null!=r?r:cr.EMPTY_NODE,this.right=null!=i?i:cr.EMPTY_NODE}function Et(){}function wt(t,e){void 0===e&&(e=wt.EMPTY_NODE),this.comparator_=t,this.root_=e}function bt(t){var e;this.count=(e=t+1,parseInt(Math.log(e)/pr,10)),this.current_=this.count-1;var n,r=(n=this.count,parseInt(Array(n+1).join("1"),2));this.bits_=t+1&r}function St(t,e){this.indexes_=t,this.indexSet_=e}function Tt(t,e){return Ln(t.name,e.name)}function It(t,e){return Ln(t,e)}function Nt(t,e,n){this.children_=t,this.priorityNode_=e,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&rr(this.priorityNode_),this.children_.isEmpty()&&Ke(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}function Rt(){return ur.call(this,new cr(It),gr.EMPTY_NODE,yr.Default)||this}function Pt(t,e){if(void 0===e&&(e=null),null===t)return gr.EMPTY_NODE;if("object"==typeof t&&".priority"in t&&(e=t[".priority"]),Ke(null===e||"string"==typeof e||"number"==typeof e||"object"==typeof e&&".sv"in e,"Invalid priority type found: "+typeof e),"object"==typeof t&&".value"in t&&null!==t[".value"]&&(t=t[".value"]),"object"!=typeof t||".sv"in t)return new ir(t,Pt(e));if(t instanceof Array||!Cr){var n=gr.EMPTY_NODE;return z(t,function(e,r){m(t,e)&&"."!==e.substring(0,1)&&(!(r=Pt(r)).isLeafNode()&&r.isEmpty()||(n=n.updateImmediateChild(e,r)))}),n.updatePriority(Pt(e))}var r=[],i=!1;if(z(t,function(t,e){"."!==t.substring(0,1)&&((e=Pt(e)).isEmpty()||(i=i||!e.getPriority().isEmpty(),r.push(new tr(t,e))))}),0===r.length)return gr.EMPTY_NODE;var o=fr(r,Tt,function(t){return t.name},It);if(i){var s=fr(r,or.getCompare());return new gr(o,Pt(e),new yr({".priority":s},{".priority":or}))}return new gr(o,Pt(e),yr.Default)}function Dt(){return null!==mr&&mr.apply(this,arguments)||this}function Ot(t){var e=Er.call(this)||this;return e.indexPath_=t,Ke(!t.isEmpty()&&".priority"!==t.getFront(),"Can't create PathIndex with empty path or .priority key"),e}function xt(t,e,n){this.node_=t,this.ref_=e,this.index_=n}function kt(t,e,n,r){this.eventType=t,this.eventRegistration=e,this.snapshot=n,this.prevName=r}function At(t,e,n){this.eventRegistration=t,this.error=e,this.path=n}function Ft(t,e,n){this.callback_=t,this.cancelCallback_=e,this.context_=n}function Lt(t,e,n){this.callbacks_=t,this.cancelCallback_=e,this.context_=n}function Mt(t,e,n,r){this.repo=t,this.path=e,this.queryParams_=n,this.orderByCalled_=r}function Wt(t){this.node_=t}function Qt(t,e){this.syncTree_=t,this.path_=e}function qt(t,e,n,r){return Vt(e,new kr(n,t),r)}function Ut(t,e,n){return Vt(t,new xr(e),n)}function Vt(t,e,n){var r=t.getPriority().val(),i=Ar(r,e.getImmediateChild(".priority"),n);if(t.isLeafNode()){var o=t;r=Ar(o.getValue(),e,n);return r!==o.getValue()||i!==o.getPriority().val()?new ir(r,Pt(i)):t}t=t;var s=t;return i!==t.getPriority().val()&&(s=s.updatePriority(new ir(i))),t.forEachChild(or,function(t,r){var i=Vt(r,e.getImmediateChild(t),n);i!==r&&(s=s.updateImmediateChild(t,i))}),s}function Ht(){this.value=null,this.children=new Map}function jt(t,e,n,r){this.fromUser=t,this.fromServer=e,this.queryId=n,this.tagged=r,Ke(!r||e,"Tagged queries must be from server.")}function Bt(t,e,n){this.path=t,this.affectedTree=e,this.revert=n,this.type=br.ACK_USER_WRITE,this.source=qr.User}function zt(t,e){void 0===e&&(e=Wr=Wr||new cr(H)),this.value=t,this.children=e}function Kt(t,e){this.source=t,this.path=e,this.type=br.LISTEN_COMPLETE}function Yt(t,e,n){this.source=t,this.path=e,this.snap=n,this.type=br.OVERWRITE}function Gt(t,e,n){this.source=t,this.path=e,this.children=n,this.type=br.MERGE}function Xt(t,e,n){this.node_=t,this.fullyInitialized_=e,this.filtered_=n}function $t(t,e){this.eventCache_=t,this.serverCache_=e}function Jt(t,e,n,r,i){this.type=t,this.snapshotNode=e,this.childName=n,this.oldSnap=r,this.prevName=i}function Zt(t){this.index_=t}function te(){this.changeMap=new Map}function ee(){}function ne(t,e,n){void 0===n&&(n=null),this.writes_=t,this.viewCache_=e,this.optCompleteServerCache_=n}function re(t){this.filter_=t}function ie(t){this.query_=t,this.index_=this.query_.getQueryParams().getIndex()}function oe(t,e){this.query_=t,this.eventRegistrations_=[];var n=this.query_.getQueryParams(),r=new Gr(n.getIndex()),i=n.getNodeFilter();this.processor_=new ti(i);var o=e.getServerCache();t=e.getEventCache(),n=r.updateFullNode(gr.EMPTY_NODE,o.getNode(),null),e=i.updateFullNode(gr.EMPTY_NODE,t.getNode(),null),r=new zr(n,o.isFullyInitialized(),r.filtersNodes()),i=new zr(e,t.isFullyInitialized(),i.filtersNodes());this.viewCache_=new Kr(i,r),this.eventGenerator_=new ei(this.query_)}function se(){this.views=new Map}function ae(t){this.writeTree_=t}function he(){this.visibleWrites_=ii.Empty,this.allWrites_=[],this.lastWriteId_=-1}function le(t,e){this.treePath_=t,this.writeTree_=e}function ue(t){this.listenProvider_=t,this.syncPointTree_=Vr.Empty,this.pendingWriteTree_=new oi,this.tagToQueryMap=new Map,this.queryToTagMap=new Map}function ce(){this.rootNode_=gr.EMPTY_NODE}function pe(){this.counters_={}}function de(){}function fe(t){this.collection_=t,this.last_=null}function _e(t,e){this.server_=e,this.statsToReport_={},this.statsListener_=new ci(t),t=1e4+2e4*Math.random(),G(this.reportStats_.bind(this),Math.floor(t))}function ye(){this.eventLists_=[],this.recursionDepth_=0}function ge(t){this.path_=t,this.events_=[]}function ve(t){this.allowedEvents_=t,this.listeners_={},Ke(Array.isArray(t)&&0<t.length,"Requires a non-empty array")}function me(){var t,e,n=_i.call(this,["visible"])||this;return"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(e="visibilitychange",t="hidden"):void 0!==document.mozHidden?(e="mozvisibilitychange",t="mozHidden"):void 0!==document.msHidden?(e="msvisibilitychange",t="msHidden"):void 0!==document.webkitHidden&&(e="webkitvisibilitychange",t="webkitHidden")),n.visible_=!0,e&&document.addEventListener(e,function(){var e=!document[t];e!==n.visible_&&(n.visible_=e,n.trigger("visible",e))},!1),n}function Ce(){var t=yi.call(this,["online"])||this;return t.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||p()||(window.addEventListener("online",function(){t.online_||(t.online_=!0,t.trigger("online",!0))},!1),window.addEventListener("offline",function(){t.online_&&(t.online_=!1,t.trigger("online",!1))},!1)),t}function Ee(t){this.onMessage_=t,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}function we(t,e,n,r,i){this.connId=t,this.repoInfo=e,this.applicationId=n,this.transportSessionId=r,this.lastSessionId=i,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=kn(t),this.stats_=ui.getCollection(e),this.urlFn=function(t){return e.connectionURL(jn,t)}}function be(t,e,n,r){this.onDisconnect=n,this.urlFn=r,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,this.uniqueCallbackIdentifier=Rn(),window[Ci+this.uniqueCallbackIdentifier]=t,window[Ei+this.uniqueCallbackIdentifier]=e,this.myIFrame=be.createIFrame_(),e="",this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length)&&(e='<script>document.domain="'+document.domain+'";</script>');var i="<html><body>"+e+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(i),this.myIFrame.doc.close()}catch(t){xn("frame writing exception"),t.stack&&xn(t.stack),xn(t)}}function Se(t){Si=t}function Te(t,e,n,r,i){this.connId=t,this.applicationId=n,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=kn(this.connId),this.stats_=ui.getCollection(e),this.connURL=Te.connectionURL_(e,r,i),this.nodeAdmin=e.nodeAdmin}function Ie(t){this.initTransports_(t)}function Ne(t,e,n,r,i,o,s,a){this.id=t,this.repoInfo_=e,this.applicationId_=n,this.onMessage_=r,this.onReady_=i,this.onDisconnect_=o,this.onKill_=s,this.lastSessionId=a,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=kn("c:"+this.id+":"),this.transportManager_=new Ni(e),this.log_("Connection created"),this.start_()}function Re(){}function Pe(t,e,n,r,i,o,s){var a=Pi.call(this)||this;if(a.repoInfo_=t,a.applicationId_=e,a.onDataUpdate_=n,a.onConnectStatus_=r,a.onServerInfoUpdate_=i,a.authTokenProvider_=o,a.authOverride_=s,a.id=Pe.nextPersistentConnectionId_++,a.log_=kn("p:"+a.id+":"),a.interruptReasons_={},a.listens=new Map,a.outstandingPuts_=[],a.outstandingPutCount_=0,a.onDisconnectRequestQueue_=[],a.connected_=!1,a.reconnectDelay_=xi,a.maxReconnectDelay_=ki,a.securityDebugCallback_=null,a.lastSessionId=null,a.establishConnectionTimer_=null,a.visible_=!1,a.requestCBHash_={},a.requestNumber_=0,a.realtime_=null,a.authToken_=null,a.forceTokenRefresh_=!1,a.invalidAuthTokenCount_=0,a.firstConnection_=!0,a.lastConnectionAttemptTime_=null,a.lastConnectionEstablishedTime_=null,s&&!d())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return a.scheduleConnect_(0),gi.getInstance().on("visible",a.onVisible_,a),-1===t.host.indexOf("fblocal")&&vi.getInstance().on("online",a.onOnline_,a),a}function De(t,e,n){var r=Di.call(this)||this;return r.repoInfo_=t,r.onDataUpdate_=e,r.authTokenProvider_=n,r.log_=kn("p:rest:"),r.listens_={},r}function Oe(t,e,n,r){this.repoInfo_=t,this.forceRestClient_=e,this.app=n,this.authTokenProvider_=r,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new di,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=new Mr,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}function xe(t){this.indexedFilter_=new Gr(t.getIndex()),this.index_=t.getIndex(),this.startPost_=xe.getStartPost_(t),this.endPost_=xe.getEndPost_(t)}function ke(t){this.rangedFilter_=new Wi(t),this.index_=t.getIndex(),this.limit_=t.getLimit(),this.reverse_=!t.isViewFromLeft()}function Ae(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=or}function Fe(t,e){if(!(t instanceof Mi))throw new Error("new Reference() no longer supported - use app.database().");return Oi.call(this,t,e,qi.DEFAULT,!1)||this}function Le(t,e,n){void 0===t&&(t=""),void 0===e&&(e=null),void 0===n&&(n=new Hi),this.name_=t,this.parent_=e,this.node_=n}function Me(t,e){var n=this;this.app_=t,this.authProvider_=e,this.auth_=null,this.auth_=e.getImmediate({optional:!0}),this.auth_||e.get().then(function(t){return n.auth_=t})}function We(){}function Qe(){this.repos_={},this.useRestClient_=!1}function qe(t){var e=this;this.repoInternal_=t,this.instanceStarted_=!1,this.INTERNAL={delete:function(){return r(e,void 0,void 0,function(){return i(this,function(t){return this.checkDeleted_("delete"),Yi.getInstance().deleteRepo(this.repo_),this.repoInternal_=null,this.rootInternal_=null,[2]})})}},t instanceof Mi||q("Don't call new Database() directly - please use firebase.database().")}var Ue,Ve,He=e(t),je=function(t,e){return(je=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},Be=function(){return(Be=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},ze={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},Ke=function(t,e){if(!t)throw Ye(e)},Ye=function(t){return new Error("Firebase Database ("+ze.SDK_VERSION+") INTERNAL ASSERT FAILED: "+t)},Ge={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],i=0;i<t.length;i+=3){var o=t[i],s=i+1<t.length,a=s?t[i+1]:0,h=i+2<t.length,l=h?t[i+2]:0,u=o>>2;o=(3&o)<<4|a>>4,a=(15&a)<<2|l>>6,l=63&l;h||(l=64,s||(a=64)),r.push(n[u],n[o],n[a],n[l])}return r.join("")},encodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(h(t),e)},decodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){for(var e=[],n=0,r=0;n<t.length;){var i,o,s,a=t[n++];a<128?e[r++]=String.fromCharCode(a):191<a&&a<224?(o=t[n++],e[r++]=String.fromCharCode((31&a)<<6|63&o)):239<a&&a<365?(i=((7&a)<<18|(63&(o=t[n++]))<<12|(63&(s=t[n++]))<<6|63&t[n++])-65536,e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))):(o=t[n++],s=t[n++],e[r++]=String.fromCharCode((15&a)<<12|(63&o)<<6|63&s))}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray:function(t,e){this.init_();for(var n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],i=0;i<t.length;){var o=n[t.charAt(i++)],s=i<t.length?n[t.charAt(i)]:0,a=++i<t.length?n[t.charAt(i)]:64,h=++i<t.length?n[t.charAt(i)]:64;if(++i,null==o||null==s||null==a||null==h)throw Error();o=o<<2|s>>4,r.push(o),64!==a&&(s=s<<4&240|a>>2,r.push(s),64!==h&&(h|=a<<6&192,r.push(h)))}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},Xe=(c.prototype.wrapCallback=function(t){var e=this;return function(n,r){n?e.reject(n):e.resolve(r),"function"==typeof t&&(e.promise.catch(function(){}),1===t.length?t(n):t(n,r))}},c),$e="FirebaseError",Je=(n(f,Ue=Error),f),Ze=(_.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r,i=e[0]||{},o=this.service+"/"+t;t=this.errors[t],t=t?(r=i,t.replace(tn,function(t,e){var n=r[e];return null!=n?String(n):"<"+e+"?>"})):"Error",t=this.serviceName+": "+t+" ("+o+").";return new Je(o,t,i)},_),tn=/\{\$([^}]+)}/g,en=(b.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},b.prototype.compress_=function(t,e){e=e||0;var n=this.W_;if("string"==typeof t)for(var r=0;r<16;r++)n[r]=t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3),e+=4;else for(r=0;r<16;r++)n[r]=t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3],e+=4;for(r=16;r<80;r++){var i=n[r-3]^n[r-8]^n[r-14]^n[r-16];n[r]=4294967295&(i<<1|i>>>31)}var o,s,a=this.chain_[0],h=this.chain_[1],l=this.chain_[2],u=this.chain_[3],c=this.chain_[4];for(r=0;r<80;r++)s=r<40?r<20?(o=u^h&(l^u),1518500249):(o=h^l^u,1859775393):r<60?(o=h&l|u&(h|l),2400959708):(o=h^l^u,3395469782),i=(a<<5|a>>>27)+o+c+s+n[r]&4294967295,c=u,u=l,l=4294967295&(h<<30|h>>>2),h=a,a=i;this.chain_[0]=this.chain_[0]+a&4294967295,this.chain_[1]=this.chain_[1]+h&4294967295,this.chain_[2]=this.chain_[2]+l&4294967295,this.chain_[3]=this.chain_[3]+u&4294967295,this.chain_[4]=this.chain_[4]+c&4294967295},b.prototype.update=function(t,e){if(null!=t){void 0===e&&(e=t.length);for(var n=e-this.blockSize,r=0,i=this.buf_,o=this.inbuf_;r<e;){if(0===o)for(;r<=n;)this.compress_(t,r),r+=this.blockSize;if("string"==typeof t){for(;r<e;)if(i[o]=t.charCodeAt(r),++r,++o===this.blockSize){this.compress_(i),o=0;break}}else for(;r<e;)if(i[o]=t[r],++r,++o===this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=e}},b.prototype.digest=function(){var t=[],e=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var n=this.blockSize-1;56<=n;n--)this.buf_[n]=255&e,e/=256;this.compress_(this.buf_);var r=0;for(n=0;n<5;n++)for(var i=24;0<=i;i-=8)t[r]=this.chain_[n]>>i&255,++r;return t},b);(Sn=Ve=Ve||{})[Sn.DEBUG=0]="DEBUG",Sn[Sn.VERBOSE=1]="VERBOSE",Sn[Sn.INFO=2]="INFO",Sn[Sn.WARN=3]="WARN",Sn[Sn.ERROR=4]="ERROR",Sn[Sn.SILENT=5]="SILENT";var nn,rn,on,sn,an,hn,ln,un,cn,pn,dn,fn={debug:Ve.DEBUG,verbose:Ve.VERBOSE,info:Ve.INFO,warn:Ve.WARN,error:Ve.ERROR,silent:Ve.SILENT},_n=Ve.INFO,yn=((er={})[Ve.DEBUG]="log",er[Ve.VERBOSE]="log",er[Ve.INFO]="info",er[Ve.WARN]="warn",er[Ve.ERROR]="error",er),gn=(Object.defineProperty(O.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in Ve))throw new TypeError('Invalid value "'+t+'" assigned to `logLevel`');this._logLevel=t},enumerable:!1,configurable:!0}),O.prototype.setLogLevel=function(t){this._logLevel="string"==typeof t?fn[t]:t},Object.defineProperty(O.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"userLogHandler",{get:function(){return this._userLogHandler},set:function(t){this._userLogHandler=t},enumerable:!1,configurable:!0}),O.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,P([this,Ve.DEBUG],t)),this._logHandler.apply(this,P([this,Ve.DEBUG],t))},O.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,P([this,Ve.VERBOSE],t)),this._logHandler.apply(this,P([this,Ve.VERBOSE],t))},O.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]
;this._userLogHandler&&this._userLogHandler.apply(this,P([this,Ve.INFO],t)),this._logHandler.apply(this,P([this,Ve.INFO],t))},O.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,P([this,Ve.WARN],t)),this._logHandler.apply(this,P([this,Ve.WARN],t))},O.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,P([this,Ve.ERROR],t)),this._logHandler.apply(this,P([this,Ve.ERROR],t))},O),vn=(x.prototype.setInstantiationMode=function(t){return this.instantiationMode=t,this},x.prototype.setMultipleInstances=function(t){return this.multipleInstances=t,this},x.prototype.setServiceProps=function(t){return this.serviceProps=t,this},x),mn="[DEFAULT]",Cn=(k.prototype.get=function(t){void 0===t&&(t=mn);var e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){var n=new Xe;this.instancesDeferred.set(e,n);try{var r=this.getOrInitializeService(e);r&&n.resolve(r)}catch(t){}}return this.instancesDeferred.get(e).promise},k.prototype.getImmediate=function(t){var e=Be({identifier:mn,optional:!1},t),n=(t=e.identifier,e.optional),r=this.normalizeInstanceIdentifier(t);try{var i=this.getOrInitializeService(r);if(i)return i;if(n)return null;throw Error("Service "+this.name+" is not available")}catch(t){if(n)return null;throw t}},k.prototype.getComponent=function(){return this.component},k.prototype.setComponent=function(t){var e,n;if(t.name!==this.name)throw Error("Mismatching Component "+t.name+" for Provider "+this.name+".");if(this.component)throw Error("Component for "+this.name+" has already been provided");if("EAGER"===(this.component=t).instantiationMode)try{this.getOrInitializeService(mn)}catch(t){}try{for(var r=o(this.instancesDeferred.entries()),i=r.next();!i.done;i=r.next()){var a=s(i.value,2),h=a[0],l=a[1],u=this.normalizeInstanceIdentifier(h);try{var c=this.getOrInitializeService(u);l.resolve(c)}catch(t){}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},k.prototype.clearInstance=function(t){void 0===t&&(t=mn),this.instancesDeferred.delete(t),this.instances.delete(t)},k.prototype.delete=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return t=Array.from(this.instances.values()),[4,Promise.all(a(t.filter(function(t){return"INTERNAL"in t}).map(function(t){return t.INTERNAL.delete()}),t.filter(function(t){return"_delete"in t}).map(function(t){return t._delete()})))];case 1:return e.sent(),[2]}})})},k.prototype.isComponentSet=function(){return null!=this.component},k.prototype.getOrInitializeService=function(t){var e,n=this.instances.get(t);return!n&&this.component&&(n=this.component.instanceFactory(this.container,(e=t)===mn?void 0:e),this.instances.set(t,n)),n||null},k.prototype.normalizeInstanceIdentifier=function(t){return!this.component||this.component.multipleInstances?t:mn},k),En=(A.prototype.addComponent=function(t){var e=this.getProvider(t.name);if(e.isComponentSet())throw new Error("Component "+t.name+" has already been registered with "+this.name);e.setComponent(t)},A.prototype.addOrOverwriteComponent=function(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)},A.prototype.getProvider=function(t){if(this.providers.has(t))return this.providers.get(t);var e=new Cn(t,this);return this.providers.set(t,e),e},A.prototype.getProviders=function(){return Array.from(this.providers.values())},A),wn=(F.prototype.set=function(t,e){null==e?this.domStorage_.removeItem(this.prefixedName_(t)):this.domStorage_.setItem(this.prefixedName_(t),g(e))},F.prototype.get=function(t){return t=this.domStorage_.getItem(this.prefixedName_(t)),null==t?null:y(t)},F.prototype.remove=function(t){this.domStorage_.removeItem(this.prefixedName_(t))},F.prototype.prefixedName_=function(t){return this.prefix_+t},F.prototype.toString=function(){return this.domStorage_.toString()},F),bn=(L.prototype.set=function(t,e){null==e?delete this.cache_[t]:this.cache_[t]=e},L.prototype.get=function(t){return m(this.cache_,t)?this.cache_[t]:null},L.prototype.remove=function(t){delete this.cache_[t]},L),Sn=function(t){try{if("undefined"!=typeof window&&void 0!==window[t]){var e=window[t];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new wn(e)}}catch(t){}return new bn},Tn=Sn("localStorage"),In=Sn("sessionStorage"),Nn=new gn("@firebase/database"),Rn=(nn=1,function(){return nn++}),Pn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n="",r=0;r<t.length;r++){var i=t[r];Array.isArray(i)||i&&"object"==typeof i&&"number"==typeof i.length?n+=Pn.apply(null,i):n+="object"==typeof i?g(i):i,n+=" "}return n},Dn=null,On=!0,xn=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];!0===On&&(On=!1,null===Dn&&!0===In.get("logging_enabled")&&W(!0)),Dn&&(t=Pn.apply(null,e),Dn(t))},kn=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];xn.apply(void 0,a([t],e))}},An="[MIN_NAME]",Fn="[MAX_NAME]",Ln=function(t,e){if(t===e)return 0;if(t===An||e===Fn)return-1;if(e===An||t===Fn)return 1;var n=Qn(t),r=Qn(e);return null!==n?null!==r?n-r==0?t.length-e.length:n-r:-1:null===r&&t<e?-1:1},Mn=function(t){if("object"!=typeof t||null===t)return g(t);var e,n=[];for(e in t)n.push(e);n.sort();for(var r="{",i=0;i<n.length;i++)0!==i&&(r+=","),r+=g(n[i]),r+=":",r+=Mn(t[n[i]]);return r+"}"},Wn=new RegExp("^-?(0*)\\d{1,10}$"),Qn=function(t){return Wn.test(t)&&(t=Number(t),-2147483648<=t&&t<=2147483647)?t:null},qn=(Object.defineProperty(X,"Empty",{get:function(){return new X("")},enumerable:!1,configurable:!0}),X.prototype.getFront=function(){return this.pieceNum_>=this.pieces_.length?null:this.pieces_[this.pieceNum_]},X.prototype.getLength=function(){return this.pieces_.length-this.pieceNum_},X.prototype.popFront=function(){var t=this.pieceNum_;return t<this.pieces_.length&&t++,new X(this.pieces_,t)},X.prototype.getBack=function(){return this.pieceNum_<this.pieces_.length?this.pieces_[this.pieces_.length-1]:null},X.prototype.toString=function(){for(var t="",e=this.pieceNum_;e<this.pieces_.length;e++)""!==this.pieces_[e]&&(t+="/"+this.pieces_[e]);return t||"/"},X.prototype.toUrlEncodedString=function(){for(var t="",e=this.pieceNum_;e<this.pieces_.length;e++)""!==this.pieces_[e]&&(t+="/"+encodeURIComponent(String(this.pieces_[e])));return t||"/"},X.prototype.slice=function(t){return void 0===t&&(t=0),this.pieces_.slice(this.pieceNum_+t)},X.prototype.parent=function(){if(this.pieceNum_>=this.pieces_.length)return null;for(var t=[],e=this.pieceNum_;e<this.pieces_.length-1;e++)t.push(this.pieces_[e]);return new X(t,0)},X.prototype.child=function(t){for(var e=[],n=this.pieceNum_;n<this.pieces_.length;n++)e.push(this.pieces_[n]);if(t instanceof X)for(n=t.pieceNum_;n<t.pieces_.length;n++)e.push(t.pieces_[n]);else{var r=t.split("/");for(n=0;n<r.length;n++)0<r[n].length&&e.push(r[n])}return new X(e,0)},X.prototype.isEmpty=function(){return this.pieceNum_>=this.pieces_.length},X.relativePath=function(t,e){var n=t.getFront(),r=e.getFront();if(null===n)return e;if(n===r)return X.relativePath(t.popFront(),e.popFront());throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+t+")")},X.comparePaths=function(t,e){for(var n=t.slice(),r=e.slice(),i=0;i<n.length&&i<r.length;i++){var o=Ln(n[i],r[i]);if(0!==o)return o}return n.length===r.length?0:n.length<r.length?-1:1},X.prototype.equals=function(t){if(this.getLength()!==t.getLength())return!1;for(var e=this.pieceNum_,n=t.pieceNum_;e<=this.pieces_.length;e++,n++)if(this.pieces_[e]!==t.pieces_[n])return!1;return!0},X.prototype.contains=function(t){var e=this.pieceNum_,n=t.pieceNum_;if(this.getLength()>t.getLength())return!1;for(;e<this.pieces_.length;){if(this.pieces_[e]!==t.pieces_[n])return!1;++e,++n}return!0},X),Un=(Object.defineProperty($,"MAX_PATH_DEPTH",{get:function(){return 32},enumerable:!1,configurable:!0}),Object.defineProperty($,"MAX_PATH_LENGTH_BYTES",{get:function(){return 768},enumerable:!1,configurable:!0}),$.prototype.push=function(t){0<this.parts_.length&&(this.byteLength_+=1),this.parts_.push(t),this.byteLength_+=R(t),this.checkValid_()},$.prototype.pop=function(){var t=this.parts_.pop();this.byteLength_-=R(t),0<this.parts_.length&&--this.byteLength_},$.prototype.checkValid_=function(){if(this.byteLength_>$.MAX_PATH_LENGTH_BYTES)throw new Error(this.errorPrefix_+"has a key path longer than "+$.MAX_PATH_LENGTH_BYTES+" bytes ("+this.byteLength_+").");if(this.parts_.length>$.MAX_PATH_DEPTH)throw new Error(this.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+$.MAX_PATH_DEPTH+") or object contains a cycle "+this.toErrorString())},$.prototype.toErrorString=function(){return 0===this.parts_.length?"":"in property '"+this.parts_.join(".")+"'"},$),Vn="firebaseio.com",Hn="websocket",jn="long_polling",Bn=(J.prototype.needsQueryParam=function(){return this.host!==this.internalHost||this.isCustomHost()||this.includeNamespaceInQueryParams},J.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},J.prototype.isDemoHost=function(){return"firebaseio-demo.com"===this.domain},J.prototype.isCustomHost=function(){return"firebaseio.com"!==this.domain&&"firebaseio-demo.com"!==this.domain},J.prototype.updateHost=function(t){t!==this.internalHost&&(this.internalHost=t,this.isCacheableHost()&&Tn.set("host:"+this.host,this.internalHost))},J.prototype.connectionURL=function(t,e){var n;if(Ke("string"==typeof t,"typeof type must == string"),Ke("object"==typeof e,"typeof params must == object"),t===Hn)n=(this.secure?"wss://":"ws://")+this.internalHost+"/.ws?";else{if(t!==jn)throw new Error("Unknown connection type: "+t);n=(this.secure?"https://":"http://")+this.internalHost+"/.lp?"}this.needsQueryParam()&&(e.ns=this.namespace);var r=[];return z(e,function(t,e){r.push(t+"="+e)}),n+r.join("&")},J.prototype.toString=function(){var t=this.toURLString();return this.persistenceKey&&(t+="<"+this.persistenceKey+">"),t},J.prototype.toURLString=function(){return(this.secure?"https://":"http://")+this.host},J),zn=function(t){var e,n,r,i="",s="",a="",h="",l="",u=!0,c="https",p=443;return"string"==typeof t&&(0<=(r=t.indexOf("//"))&&(c=t.substring(0,r-1),t=t.substring(r+2)),-1===(e=t.indexOf("/"))&&(e=t.length),-1===(n=t.indexOf("?"))&&(n=t.length),i=t.substring(0,Math.min(e,n)),e<n&&(h=function(t){for(var e="",n=t.split("/"),r=0;r<n.length;r++)if(0<n[r].length){var i=n[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch(t){}e+="/"+i}return e}(t.substring(e,n))),n=function(t){var e,n,r={};"?"===t.charAt(0)&&(t=t.substring(1));try{for(var i=o(t.split("&")),s=i.next();!s.done;s=i.next()){var a,h=s.value;0!==h.length&&(2===(a=h.split("=")).length?r[decodeURIComponent(a[0])]=decodeURIComponent(a[1]):U("Invalid query segment '"+h+"' in query '"+t+"'"))}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r}(t.substring(Math.min(t.length,n))),0<=(r=i.indexOf(":"))?(u="https"===c||"wss"===c,p=parseInt(i.substring(r+1),10)):r=i.length,"localhost"===(r=i.slice(0,r)).toLowerCase()?s="localhost":r.split(".").length<=2?s=r:(r=i.indexOf("."),a=i.substring(0,r).toLowerCase(),s=i.substring(r+1),l=a),"ns"in n&&(l=n.ns)),{host:i,port:p,domain:s,subdomain:a,secure:u,scheme:c,pathString:h,namespace:l}},Kn=/[\[\].#$\/\u0000-\u001F\u007F]/,Yn=/[\[\].#$\u0000-\u001F\u007F]/,Gn=10485760,Xn=function(t,e,n){var r=n instanceof qn?new Un(n,t):n;if(void 0===e)throw new Error(t+"contains undefined "+r.toErrorString());if("function"==typeof e)throw new Error(t+"contains a function "+r.toErrorString()+" with contents = "+e.toString());if(V(e))throw new Error(t+"contains "+e.toString()+" "+r.toErrorString());if("string"==typeof e&&e.length>Gn/3&&R(e)>Gn)throw new Error(t+"contains a string greater than "+Gn+" utf8 bytes "+r.toErrorString()+" ('"+e.substring(0,50)+"...')");if(e&&"object"==typeof e){var i=!1,o=!1;if(z(e,function(e,n){if(".value"===e)i=!0;else if(".priority"!==e&&".sv"!==e&&(o=!0,!tt(e)))throw new Error(t+" contains an invalid key ("+e+") "+r.toErrorString()+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');r.push(e),Xn(t,n,r),r.pop()}),i&&o)throw new Error(t+' contains ".value" child '+r.toErrorString()+" in addition to actual children.")}},$n=(ct.prototype.cancel=function(t){S("OnDisconnect.cancel",0,1,arguments.length),I("OnDisconnect.cancel",1,t,!0);var e=new Xe;return this.repo_.onDisconnectCancel(this.path_,e.wrapCallback(t)),e.promise},ct.prototype.remove=function(t){S("OnDisconnect.remove",0,1,arguments.length),lt("OnDisconnect.remove",this.path_),I("OnDisconnect.remove",1,t,!0);var e=new Xe;return this.repo_.onDisconnectSet(this.path_,null,e.wrapCallback(t)),e.promise},ct.prototype.set=function(t,e){S("OnDisconnect.set",1,2,arguments.length),lt("OnDisconnect.set",this.path_),rt("OnDisconnect.set",1,t,this.path_,!1),I("OnDisconnect.set",2,e,!0);var n=new Xe;return this.repo_.onDisconnectSet(this.path_,t,n.wrapCallback(e)),n.promise},ct.prototype.setWithPriority=function(t,e,n){S("OnDisconnect.setWithPriority",2,3,arguments.length),lt("OnDisconnect.setWithPriority",this.path_),rt("OnDisconnect.setWithPriority",1,t,this.path_,!1),ot("OnDisconnect.setWithPriority",2,e,!1),I("OnDisconnect.setWithPriority",3,n,!0);var r=new Xe;return this.repo_.onDisconnectSetWithPriority(this.path_,t,e,r.wrapCallback(n)),r.promise},ct.prototype.update=function(t,e){if(S("OnDisconnect.update",1,2,arguments.length),lt("OnDisconnect.update",this.path_),Array.isArray(t)){for(var n={},r=0;r<t.length;++r)n[""+r]=t[r];t=n,U("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}it("OnDisconnect.update",1,t,this.path_,!1),I("OnDisconnect.update",2,e,!0);var i=new Xe;return this.repo_.onDisconnectUpdate(this.path_,t,i.wrapCallback(e)),i.promise},ct),Jn=(pt.prototype.toJSON=function(){return S("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},pt),Zn=(rn="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",on=0,sn=[],function(t){var e=t===on;on=t;for(var n=new Array(8),r=7;0<=r;r--)n[r]=rn.charAt(t%64),t=Math.floor(t/64);Ke(0===t,"Cannot push at time == 0");var i=n.join("");if(e){for(r=11;0<=r&&63===sn[r];r--)sn[r]=0;sn[r]++}else for(r=0;r<12;r++)sn[r]=Math.floor(64*Math.random());for(r=0;r<12;r++)i+=rn.charAt(sn[r]);return Ke(20===i.length,"nextPushId: Length should be 20."),i}),tr=(dt.Wrap=function(t,e){return new dt(t,e)},dt),er=(ft.prototype.getCompare=function(){return this.compare.bind(this)},ft.prototype.indexedValueChanged=function(t,e){return t=new tr(An,t),e=new tr(An,e),0!==this.compare(t,e)},ft.prototype.minPost=function(){return tr.MIN},ft),nr=(Sn=(n(_t,hn=er),Object.defineProperty(_t,"__EMPTY_NODE",{get:function(){return an},set:function(t){an=t},enumerable:!1,configurable:!0}),_t.prototype.compare=function(t,e){return Ln(t.name,e.name)},_t.prototype.isDefinedOn=function(t){throw Ye("KeyIndex.isDefinedOn not expected to be called.")},_t.prototype.indexedValueChanged=function(t,e){return!1},_t.prototype.minPost=function(){return tr.MIN},_t.prototype.maxPost=function(){return new tr(Fn,an)},_t.prototype.makePost=function(t,e){return Ke("string"==typeof t,"KeyIndex indexValue must always be a string."),new tr(t,an)},_t.prototype.toString=function(){return".key"},_t),new Sn),rr=function(t){var e;t.isLeafNode()?(e=t.val(),Ke("string"==typeof e||"number"==typeof e||"object"==typeof e&&m(e,".sv"),"Priority must be a string or number.")):Ke(t===ln||t.isEmpty(),"priority of unexpected type."),Ke(t===ln||t.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},ir=(Object.defineProperty(gt,"__childrenNodeConstructor",{get:function(){return un},set:function(t){un=t},enumerable:!1,configurable:!0}),gt.prototype.isLeafNode=function(){return!0},gt.prototype.getPriority=function(){return this.priorityNode_},gt.prototype.updatePriority=function(t){return new gt(this.value_,t)},gt.prototype.getImmediateChild=function(t){return".priority"===t?this.priorityNode_:gt.__childrenNodeConstructor.EMPTY_NODE},gt.prototype.getChild=function(t){return t.isEmpty()?this:".priority"===t.getFront()?this.priorityNode_:gt.__childrenNodeConstructor.EMPTY_NODE},gt.prototype.hasChild=function(){return!1},gt.prototype.getPredecessorChildName=function(t,e){return null},gt.prototype.updateImmediateChild=function(t,e){return".priority"===t?this.updatePriority(e):e.isEmpty()&&".priority"!==t?this:gt.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,e).updatePriority(this.priorityNode_)},gt.prototype.updateChild=function(t,e){var n=t.getFront();return null===n?e:e.isEmpty()&&".priority"!==n?this:(Ke(".priority"!==n||1===t.getLength(),".priority must be the last token in a path"),this.updateImmediateChild(n,gt.__childrenNodeConstructor.EMPTY_NODE.updateChild(t.popFront(),e)))},gt.prototype.isEmpty=function(){return!1},gt.prototype.numChildren=function(){return 0},gt.prototype.forEachChild=function(t,e){return!1},gt.prototype.val=function(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},gt.prototype.hash=function(){var t,e;return null===this.lazyHash_&&(t="",this.priorityNode_.isEmpty()||(t+="priority:"+yt(this.priorityNode_.val())+":"),t+=(e=typeof this.value_)+":",t+="number"==e?K(this.value_):this.value_,this.lazyHash_=M(t)),this.lazyHash_},gt.prototype.getValue=function(){return this.value_},gt.prototype.compareTo=function(t){return t===gt.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof gt.__childrenNodeConstructor?-1:(Ke(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))},gt.prototype.compareToLeafNode_=function(t){var e=typeof t.value_,n=typeof this.value_,r=gt.VALUE_TYPE_ORDER.indexOf(e),i=gt.VALUE_TYPE_ORDER.indexOf(n);return Ke(0<=r,"Unknown leaf type: "+e),Ke(0<=i,"Unknown leaf type: "+n),r===i?"object"==n?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:i-r},gt.prototype.withIndex=function(){return this},gt.prototype.isIndexed=function(){return!0},gt.prototype.equals=function(t){return t===this||!!t.isLeafNode()&&this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)},gt.VALUE_TYPE_ORDER=["object","boolean","number","string"],gt),or=new(n(vt,dn=er),vt.prototype.compare=function(t,e){var n=t.node.getPriority(),r=e.node.getPriority();r=n.compareTo(r);return 0===r?Ln(t.name,e.name):r},vt.prototype.isDefinedOn=function(t){return!t.getPriority().isEmpty()},vt.prototype.indexedValueChanged=function(t,e){return!t.getPriority().equals(e.getPriority())},vt.prototype.minPost=function(){return tr.MIN},vt.prototype.maxPost=function(){return new tr(Fn,new ir("[PRIORITY-POST]",pn))},vt.prototype.makePost=function(t,e){return t=cn(t),new tr(e,new ir("[PRIORITY-POST]",t))},vt.prototype.toString=function(){return".priority"},vt),sr=(mt.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var t=this.nodeStack_.pop(),e=this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value};if(this.isReverse_)for(t=t.left;!t.isEmpty();)this.nodeStack_.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack_.push(t),t=t.left;return e},mt.prototype.hasNext=function(){return 0<this.nodeStack_.length},mt.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var t=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value}},mt),ar=(Ct.prototype.copy=function(t,e,n,r,i){return new Ct(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},Ct.prototype.count=function(){return this.left.count()+1+this.right.count()},Ct.prototype.isEmpty=function(){return!1},Ct.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)},Ct.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},Ct.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},Ct.prototype.minKey=function(){return this.min_().key},Ct.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},Ct.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp_()},Ct.prototype.removeMin_=function(){if(this.left.isEmpty())return cr.EMPTY_NODE;var t=this;return t.left.isRed_()||t.left.left.isRed_()||(t=t.moveRedLeft_()),(t=t.copy(null,null,null,t.left.removeMin_(),null)).fixUp_()},Ct.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed_()||r.left.left.isRed_()||(r=r.moveRedLeft_()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed_()&&(r=r.rotateRight_()),r.right.isEmpty()||r.right.isRed_()||r.right.left.isRed_()||(r=r.moveRedRight_()),0===e(t,r.key)){if(r.right.isEmpty())return cr.EMPTY_NODE;n=r.right.min_(),r=r.copy(n.key,n.value,null,null,r.right.removeMin_())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp_()},Ct.prototype.isRed_=function(){return this.color},Ct.prototype.fixUp_=function(){var t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t},Ct.prototype.moveRedLeft_=function(){var t=this.colorFlip_();return t.right.left.isRed_()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight_())).rotateLeft_()).colorFlip_()),t},Ct.prototype.moveRedRight_=function(){var t=this.colorFlip_();return t.left.left.isRed_()&&(t=(t=t.rotateRight_()).colorFlip_()),t},Ct.prototype.rotateLeft_=function(){var t=this.copy(null,null,Ct.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},Ct.prototype.rotateRight_=function(){var t=this.copy(null,null,Ct.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},Ct.prototype.colorFlip_=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},Ct.prototype.checkMaxDepth_=function(){var t=this.check_();return Math.pow(2,t)<=this.count()+1},Ct.prototype.check_=function(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)},Ct.RED=!0,Ct.BLACK=!1,Ct);Et.prototype.copy=function(t,e,n,r,i){return this},Et.prototype.insert=function(t,e,n){return new ar(t,e,null)},Et.prototype.remove=function(t,e){return this},Et.prototype.count=function(){return 0},Et.prototype.isEmpty=function(){return!0},Et.prototype.inorderTraversal=function(t){return!1},Et.prototype.reverseTraversal=function(t){return!1},Et.prototype.minKey=function(){return null},Et.prototype.maxKey=function(){return null},Et.prototype.check_=function(){return 0},Et.prototype.isRed_=function(){return!1},gn=Et;var hr,lr,ur,cr=(wt.prototype.insert=function(t,e){return new wt(this.comparator_,this.root_.insert(t,e,this.comparator_).copy(null,null,ar.BLACK,null,null))},wt.prototype.remove=function(t){return new wt(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,ar.BLACK,null,null))},wt.prototype.get=function(t){for(var e,n=this.root_;!n.isEmpty();){if(0===(e=this.comparator_(t,n.key)))return n.value;e<0?n=n.left:0<e&&(n=n.right)}return null},wt.prototype.getPredecessorKey=function(t){for(var e,n=this.root_,r=null;!n.isEmpty();){if(0===(e=this.comparator_(t,n.key))){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}e<0?n=n.left:0<e&&(n=(r=n).right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},wt.prototype.isEmpty=function(){return this.root_.isEmpty()},wt.prototype.count=function(){return this.root_.count()},wt.prototype.minKey=function(){return this.root_.minKey()},wt.prototype.maxKey=function(){return this.root_.maxKey()},wt.prototype.inorderTraversal=function(t){return this.root_.inorderTraversal(t)},wt.prototype.reverseTraversal=function(t){return this.root_.reverseTraversal(t)},wt.prototype.getIterator=function(t){return new sr(this.root_,null,this.comparator_,!1,t)},wt.prototype.getIteratorFrom=function(t,e){return new sr(this.root_,t,this.comparator_,!1,e)},wt.prototype.getReverseIteratorFrom=function(t,e){return new sr(this.root_,t,this.comparator_,!0,e)},wt.prototype.getReverseIterator=function(t){return new sr(this.root_,null,this.comparator_,!0,t)},wt.EMPTY_NODE=new gn,wt),pr=Math.log(2),dr=(bt.prototype.nextBitIsOne=function(){var t=!(this.bits_&1<<this.current_);return this.current_--,t},bt),fr=function(t,e,n,r){t.sort(e);var i=function(e,r){var o=r-e;if(0==o)return null;if(1==o)return s=t[e],a=n?n(s):s,new ar(a,s.node,ar.BLACK,null,null);o=parseInt(o/2,10)+e,e=i(e,o),r=i(o+1,r);var s=t[o],a=n?n(s):s;return new ar(a,s.node,ar.BLACK,e,r)},o=function(e){for(var r=null,o=null,s=t.length,a=function(e,r){var o=s-e,a=s;s-=e,e=i(1+o,a),a=t[o],o=n?n(a):a,h(new ar(o,a.node,r,null,e))},h=function(t){r=r?r.left=t:o=t},l=0;l<e.count;++l){var u=e.nextBitIsOne(),c=Math.pow(2,e.count-(l+1));u?a(c,ar.BLACK):(a(c,ar.BLACK),a(c,ar.RED))}return o}(new dr(t.length));return new cr(r||e,o)},_r={},yr=(Object.defineProperty(St,"Default",{get:function(){return Ke(or,"ChildrenNode.ts has not been loaded"),hr=hr||new St({".priority":_r},{".priority":or})},enumerable:!1,configurable:!0}),St.prototype.get=function(t){var e=C(this.indexes_,t);if(!e)throw new Error("No index defined for "+t);return e instanceof cr?e:null},St.prototype.hasIndex=function(t){return m(this.indexSet_,t.toString())},St.prototype.addIndex=function(t,e){Ke(t!==nr,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var n,r=[],i=!1,o=e.getIterator(tr.Wrap),s=o.getNext();s;)i=i||t.isDefinedOn(s.node),r.push(s),s=o.getNext();n=i?fr(r,t.getCompare()):_r;var a=t.toString(),h=Be({},this.indexSet_);return h[a]=t,e=Be({},this.indexes_),e[a]=n,new St(e,h)},St.prototype.addToIndexes=function(t,e){var n=this;return new St(w(this.indexes_,function(r,i){var o=C(n.indexSet_,i);if(Ke(o,"Missing index implementation for "+i),r===_r){if(o.isDefinedOn(t.node)){for(var s=[],a=e.getIterator(tr.Wrap),h=a.getNext();h;)h.name!==t.name&&s.push(h),h=a.getNext();return s.push(t),fr(s,o.getCompare())}return _r}return o=e.get(t.name),o&&(r=r.remove(new tr(t.name,o))),r.insert(t,t.node)}),this.indexSet_)},St.prototype.removeFromIndexes=function(t,e){return new St(w(this.indexes_,function(n){if(n===_r)return n;var r=e.get(t.name);return r?n.remove(new tr(t.name,r)):n}),this.indexSet_)},St),gr=(Object.defineProperty(Nt,"EMPTY_NODE",{get:function(){return lr=lr||new Nt(new cr(It),null,yr.Default)},enumerable:!1,configurable:!0}),Nt.prototype.isLeafNode=function(){return!1},Nt.prototype.getPriority=function(){return this.priorityNode_||lr},Nt.prototype.updatePriority=function(t){return this.children_.isEmpty()?this:new Nt(this.children_,t,this.indexMap_)},Nt.prototype.getImmediateChild=function(t){return".priority"===t?this.getPriority():(t=this.children_.get(t),null===t?lr:t)},Nt.prototype.getChild=function(t){var e=t.getFront();return null===e?this:this.getImmediateChild(e).getChild(t.popFront())},Nt.prototype.hasChild=function(t){return null!==this.children_.get(t)},Nt.prototype.updateImmediateChild=function(t,e){if(Ke(e,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(e);var n=new tr(t,e),r=void 0,i=void 0;i=e.isEmpty()?(r=this.children_.remove(t),this.indexMap_.removeFromIndexes(n,this.children_)):(r=this.children_.insert(t,e),this.indexMap_.addToIndexes(n,this.children_)),n=r.isEmpty()?lr:this.priorityNode_;return new Nt(r,n,i)},Nt.prototype.updateChild=function(t,e){var n=t.getFront();return null===n?e:(Ke(".priority"!==t.getFront()||1===t.getLength(),".priority must be the last token in a path"),e=this.getImmediateChild(n).updateChild(t.popFront(),e),this.updateImmediateChild(n,e))},Nt.prototype.isEmpty=function(){return this.children_.isEmpty()},Nt.prototype.numChildren=function(){return this.children_.count()},Nt.prototype.val=function(t){if(this.isEmpty())return null;var e={},n=0,r=0,i=!0;if(this.forEachChild(or,function(o,s){e[o]=s.val(t),n++,i&&Nt.INTEGER_REGEXP_.test(o)?r=Math.max(r,Number(o)):i=!1}),!t&&i&&r<2*n){var o,s=[];for(o in e)s[o]=e[o];return s}return t&&!this.getPriority().isEmpty()&&(e[".priority"]=this.getPriority().val()),e},Nt.prototype.hash=function(){var t;return null===this.lazyHash_&&(t="",this.getPriority().isEmpty()||(t+="priority:"+yt(this.getPriority().val())+":"),this.forEachChild(or,function(e,n){n=n.hash(),""!==n&&(t+=":"+e+":"+n)}),this.lazyHash_=""===t?"":M(t)),this.lazyHash_},Nt.prototype.getPredecessorChildName=function(t,e,n){return n=this.resolveIndex_(n),n?(e=n.getPredecessorKey(new tr(t,e)),e?e.name:null):this.children_.getPredecessorKey(t)},Nt.prototype.getFirstChildName=function(t){return t=this.resolveIndex_(t),t?(t=t.minKey(),t&&t.name):this.children_.minKey()},Nt.prototype.getFirstChild=function(t){return t=this.getFirstChildName(t),t?new tr(t,this.children_.get(t)):null},Nt.prototype.getLastChildName=function(t){return t=this.resolveIndex_(t),t?(t=t.maxKey(),t&&t.name):this.children_.maxKey()},Nt.prototype.getLastChild=function(t){return t=this.getLastChildName(t),t?new tr(t,this.children_.get(t)):null},Nt.prototype.forEachChild=function(t,e){return t=this.resolveIndex_(t),t?t.inorderTraversal(function(t){return e(t.name,t.node)}):this.children_.inorderTraversal(e)},Nt.prototype.getIterator=function(t){return this.getIteratorFrom(t.minPost(),t)},Nt.prototype.getIteratorFrom=function(t,e){var n=this.resolveIndex_(e);if(n)return n.getIteratorFrom(t,function(t){return t});for(var r=this.children_.getIteratorFrom(t.name,tr.Wrap),i=r.peek();null!=i&&e.compare(i,t)<0;)r.getNext(),i=r.peek();return r},Nt.prototype.getReverseIterator=function(t){return this.getReverseIteratorFrom(t.maxPost(),t)},Nt.prototype.getReverseIteratorFrom=function(t,e){var n=this.resolveIndex_(e);if(n)return n.getReverseIteratorFrom(t,function(t){return t});for(var r=this.children_.getReverseIteratorFrom(t.name,tr.Wrap),i=r.peek();null!=i&&0<e.compare(i,t);)r.getNext(),i=r.peek();return r},Nt.prototype.compareTo=function(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===vr?-1:0},Nt.prototype.withIndex=function(t){return t===nr||this.indexMap_.hasIndex(t)?this:(t=this.indexMap_.addIndex(t,this.children_),new Nt(this.children_,this.priorityNode_,t))},Nt.prototype.isIndexed=function(t){return t===nr||this.indexMap_.hasIndex(t)},Nt.prototype.equals=function(t){if(t===this)return!0;if(t.isLeafNode())return!1;if(this.getPriority().equals(t.getPriority())){if(this.children_.count()!==t.children_.count())return!1;for(var e=this.getIterator(or),n=t.getIterator(or),r=e.getNext(),i=n.getNext();r&&i;){if(r.name!==i.name||!r.node.equals(i.node))return!1;r=e.getNext(),i=n.getNext()}return null===r&&null===i}return!1},Nt.prototype.resolveIndex_=function(t){return t===nr?null:this.indexMap_.get(t.toString())},Nt.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,Nt),vr=new(n(Rt,ur=gr),Rt.prototype.compareTo=function(t){return t===this?0:1},Rt.prototype.equals=function(t){return t===this},
Rt.prototype.getPriority=function(){return this},Rt.prototype.getImmediateChild=function(t){return gr.EMPTY_NODE},Rt.prototype.isEmpty=function(){return!1},Rt);Object.defineProperties(tr,{MIN:{value:new tr(An,gr.EMPTY_NODE)},MAX:{value:new tr(Fn,vr)}}),Sn.__EMPTY_NODE=gr.EMPTY_NODE,ir.__childrenNodeConstructor=gr,ln=vr,pn=vr;var mr,Cr=!0;cn=Pt;var Er,wr,br,Sr=new(n(Dt,mr=er),Dt.prototype.compare=function(t,e){var n=t.node.compareTo(e.node);return 0===n?Ln(t.name,e.name):n},Dt.prototype.isDefinedOn=function(t){return!0},Dt.prototype.indexedValueChanged=function(t,e){return!t.equals(e)},Dt.prototype.minPost=function(){return tr.MIN},Dt.prototype.maxPost=function(){return tr.MAX},Dt.prototype.makePost=function(t,e){return t=Pt(t),new tr(e,t)},Dt.prototype.toString=function(){return".value"},Dt),Tr=(n(Ot,Er=er),Ot.prototype.extractChild=function(t){return t.getChild(this.indexPath_)},Ot.prototype.isDefinedOn=function(t){return!t.getChild(this.indexPath_).isEmpty()},Ot.prototype.compare=function(t,e){var n=this.extractChild(t.node),r=this.extractChild(e.node);r=n.compareTo(r);return 0===r?Ln(t.name,e.name):r},Ot.prototype.makePost=function(t,e){return t=Pt(t),t=gr.EMPTY_NODE.updateChild(this.indexPath_,t),new tr(e,t)},Ot.prototype.maxPost=function(){var t=gr.EMPTY_NODE.updateChild(this.indexPath_,vr);return new tr(Fn,t)},Ot.prototype.toString=function(){return this.indexPath_.slice().join("/")},Ot),Ir=(xt.prototype.val=function(){return S("DataSnapshot.val",0,0,arguments.length),this.node_.val()},xt.prototype.exportVal=function(){return S("DataSnapshot.exportVal",0,0,arguments.length),this.node_.val(!0)},xt.prototype.toJSON=function(){return S("DataSnapshot.toJSON",0,1,arguments.length),this.exportVal()},xt.prototype.exists=function(){return S("DataSnapshot.exists",0,0,arguments.length),!this.node_.isEmpty()},xt.prototype.child=function(t){S("DataSnapshot.child",0,1,arguments.length),t=String(t),ht("DataSnapshot.child",1,t,!1);var e=new qn(t);t=this.ref_.child(e);return new xt(this.node_.getChild(e),t,or)},xt.prototype.hasChild=function(t){return S("DataSnapshot.hasChild",1,1,arguments.length),ht("DataSnapshot.hasChild",1,t,!1),t=new qn(t),!this.node_.getChild(t).isEmpty()},xt.prototype.getPriority=function(){return S("DataSnapshot.getPriority",0,0,arguments.length),this.node_.getPriority().val()},xt.prototype.forEach=function(t){var e=this;return S("DataSnapshot.forEach",1,1,arguments.length),I("DataSnapshot.forEach",1,t,!1),!this.node_.isLeafNode()&&!!this.node_.forEachChild(this.index_,function(n,r){return t(new xt(r,e.ref_.child(n),or))})},xt.prototype.hasChildren=function(){return S("DataSnapshot.hasChildren",0,0,arguments.length),!this.node_.isLeafNode()&&!this.node_.isEmpty()},Object.defineProperty(xt.prototype,"key",{get:function(){return this.ref_.getKey()},enumerable:!1,configurable:!0}),xt.prototype.numChildren=function(){return S("DataSnapshot.numChildren",0,0,arguments.length),this.node_.numChildren()},xt.prototype.getRef=function(){return S("DataSnapshot.ref",0,0,arguments.length),this.ref_},Object.defineProperty(xt.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0}),xt),Nr=(kt.prototype.getPath=function(){var t=this.snapshot.getRef();return("value"===this.eventType?t:t.getParent()).path},kt.prototype.getEventType=function(){return this.eventType},kt.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},kt.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+g(this.snapshot.exportVal())},kt),Rr=(At.prototype.getPath=function(){return this.path},At.prototype.getEventType=function(){return"cancel"},At.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},At.prototype.toString=function(){return this.path.toString()+":cancel"},At),Pr=(Ft.prototype.respondsTo=function(t){return"value"===t},Ft.prototype.createEvent=function(t,e){var n=e.getQueryParams().getIndex();return new Nr("value",this,new Ir(t.snapshotNode,e.getRef(),n))},Ft.prototype.getEventRunner=function(t){var e=this.context_;if("cancel"===t.getEventType()){Ke(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(e,t.error)}}var r=this.callback_;return function(){r.call(e,t.snapshot)}},Ft.prototype.createCancelEvent=function(t,e){return this.cancelCallback_?new Rr(this,t,e):null},Ft.prototype.matches=function(t){return t instanceof Ft&&(!t.callback_||!this.callback_||t.callback_===this.callback_&&t.context_===this.context_)},Ft.prototype.hasAnyCallback=function(){return null!==this.callback_},Ft),Dr=(Lt.prototype.respondsTo=function(t){return t="children_removed"===(t="children_added"===t?"child_added":t)?"child_removed":t,m(this.callbacks_,t)},Lt.prototype.createCancelEvent=function(t,e){return this.cancelCallback_?new Rr(this,t,e):null},Lt.prototype.createEvent=function(t,e){Ke(null!=t.childName,"Child events should have a childName.");var n=e.getRef().child(t.childName);e=e.getQueryParams().getIndex();return new Nr(t.type,this,new Ir(t.snapshotNode,n,e),t.prevName)},Lt.prototype.getEventRunner=function(t){var e=this.context_;if("cancel"===t.getEventType()){Ke(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(e,t.error)}}var r=this.callbacks_[t.eventType];return function(){r.call(e,t.snapshot,t.prevName)}},Lt.prototype.matches=function(t){var e=this;if(t instanceof Lt){if(!this.callbacks_||!t.callbacks_)return!0;if(this.context_===t.context_){var n=Object.keys(t.callbacks_),r=Object.keys(this.callbacks_),i=n.length;if(i===r.length)return 1!==i?r.every(function(n){return t.callbacks_[n]===e.callbacks_[n]}):(n=n[0],r=r[0],!(r!==n||t.callbacks_[n]&&this.callbacks_[r]&&t.callbacks_[n]!==this.callbacks_[r]))}}return!1},Lt.prototype.hasAnyCallback=function(){return null!==this.callbacks_},Lt),Or=(Object.defineProperty(Mt,"__referenceConstructor",{get:function(){return Ke(wr,"Reference.ts has not been loaded"),wr},set:function(t){wr=t},enumerable:!1,configurable:!0}),Mt.validateQueryEndpoints_=function(t){var e=null,n=null;if(t.hasStart()&&(e=t.getIndexStartValue()),t.hasEnd()&&(n=t.getIndexEndValue()),t.getIndex()===nr){var r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.";if(t.hasStart()){if(t.getIndexStartName()!==An)throw new Error(r);if("string"!=typeof e)throw new Error(i)}if(t.hasEnd()){if(t.getIndexEndName()!==Fn)throw new Error(r);if("string"!=typeof n)throw new Error(i)}}else if(t.getIndex()===or){if(null!=e&&!nt(e)||null!=n&&!nt(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), endAt(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(Ke(t.getIndex()instanceof Tr||t.getIndex()===Sr,"unknown index type."),null!=e&&"object"==typeof e||null!=n&&"object"==typeof n)throw new Error("Query: First argument passed to startAt(), endAt(), or equalTo() cannot be an object.")},Mt.validateLimit_=function(t){if(t.hasStart()&&t.hasEnd()&&t.hasLimit()&&!t.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), endAt(), and limit(). Use limitToFirst() or limitToLast() instead.")},Mt.prototype.validateNoPreviousOrderByCall_=function(t){if(!0===this.orderByCalled_)throw new Error(t+": You can't combine multiple orderBy calls.")},Mt.prototype.getQueryParams=function(){return this.queryParams_},Mt.prototype.getRef=function(){return S("Query.ref",0,0,arguments.length),new Mt.__referenceConstructor(this.repo,this.path)},Mt.prototype.on=function(t,e,n,r){return S("Query.on",2,4,arguments.length),st("Query.on",1,t,!1),I("Query.on",2,e,!1),n=Mt.getCancelAndContextArgs_("Query.on",n,r),"value"===t?this.onValueEvent(e,n.cancel,n.context):((r={})[t]=e,this.onChildEvent(r,n.cancel,n.context)),e},Mt.prototype.onValueEvent=function(t,e,n){n=new Pr(t,e||null,n||null),this.repo.addEventCallbackForQuery(this,n)},Mt.prototype.onChildEvent=function(t,e,n){n=new Dr(t,e,n),this.repo.addEventCallbackForQuery(this,n)},Mt.prototype.off=function(t,e,n){S("Query.off",0,3,arguments.length),st("Query.off",1,t,!0),I("Query.off",2,e,!0),N("Query.off",3,n,!0);var r=null,i=null;"value"===t?r=new Pr(e||null,null,n||null):t&&(e&&((i={})[t]=e),r=new Dr(i,null,n||null)),this.repo.removeEventCallbackForQuery(this,r)},Mt.prototype.once=function(t,e,n,r){var i=this;S("Query.once",1,4,arguments.length),st("Query.once",1,t,!1),I("Query.once",2,e,!0);var o=Mt.getCancelAndContextArgs_("Query.once",n,r),s=!0,a=new Xe;a.promise.catch(function(){});var h=function(n){s&&(s=!1,i.off(t,h),e&&e.bind(o.context)(n),a.resolve(n))};return this.on(t,h,function(e){i.off(t,h),o.cancel&&o.cancel.bind(o.context)(e),a.reject(e)}),a.promise},Mt.prototype.limitToFirst=function(t){if(S("Query.limitToFirst",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToFirst: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToFirst: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Mt(this.repo,this.path,this.queryParams_.limitToFirst(t),this.orderByCalled_)},Mt.prototype.limitToLast=function(t){if(S("Query.limitToLast",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToLast: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToLast: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Mt(this.repo,this.path,this.queryParams_.limitToLast(t),this.orderByCalled_)},Mt.prototype.orderByChild=function(t){if(S("Query.orderByChild",1,1,arguments.length),"$key"===t)throw new Error('Query.orderByChild: "$key" is invalid.  Use Query.orderByKey() instead.');if("$priority"===t)throw new Error('Query.orderByChild: "$priority" is invalid.  Use Query.orderByPriority() instead.');if("$value"===t)throw new Error('Query.orderByChild: "$value" is invalid.  Use Query.orderByValue() instead.');if(ht("Query.orderByChild",1,t,!1),this.validateNoPreviousOrderByCall_("Query.orderByChild"),t=new qn(t),t.isEmpty())throw new Error("Query.orderByChild: cannot pass in empty path.  Use Query.orderByValue() instead.");return t=new Tr(t),t=this.queryParams_.orderBy(t),Mt.validateQueryEndpoints_(t),new Mt(this.repo,this.path,t,!0)},Mt.prototype.orderByKey=function(){S("Query.orderByKey",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByKey");var t=this.queryParams_.orderBy(nr);return Mt.validateQueryEndpoints_(t),new Mt(this.repo,this.path,t,!0)},Mt.prototype.orderByPriority=function(){S("Query.orderByPriority",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByPriority");var t=this.queryParams_.orderBy(or);return Mt.validateQueryEndpoints_(t),new Mt(this.repo,this.path,t,!0)},Mt.prototype.orderByValue=function(){S("Query.orderByValue",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByValue");var t=this.queryParams_.orderBy(Sr);return Mt.validateQueryEndpoints_(t),new Mt(this.repo,this.path,t,!0)},Mt.prototype.startAt=function(t,e){void 0===t&&(t=null),S("Query.startAt",0,2,arguments.length),rt("Query.startAt",1,t,this.path,!0),at("Query.startAt",2,e,!0);var n=this.queryParams_.startAt(t,e);if(Mt.validateLimit_(n),Mt.validateQueryEndpoints_(n),this.queryParams_.hasStart())throw new Error("Query.startAt: Starting point was already set (by another call to startAt or equalTo).");return void 0===t&&(e=t=null),new Mt(this.repo,this.path,n,this.orderByCalled_)},Mt.prototype.endAt=function(t,e){if(void 0===t&&(t=null),S("Query.endAt",0,2,arguments.length),rt("Query.endAt",1,t,this.path,!0),at("Query.endAt",2,e,!0),e=this.queryParams_.endAt(t,e),Mt.validateLimit_(e),Mt.validateQueryEndpoints_(e),this.queryParams_.hasEnd())throw new Error("Query.endAt: Ending point was already set (by another call to endAt or equalTo).");return new Mt(this.repo,this.path,e,this.orderByCalled_)},Mt.prototype.equalTo=function(t,e){if(S("Query.equalTo",1,2,arguments.length),rt("Query.equalTo",1,t,this.path,!1),at("Query.equalTo",2,e,!0),this.queryParams_.hasStart())throw new Error("Query.equalTo: Starting point was already set (by another call to startAt or equalTo).");if(this.queryParams_.hasEnd())throw new Error("Query.equalTo: Ending point was already set (by another call to endAt or equalTo).");return this.startAt(t,e).endAt(t,e)},Mt.prototype.toString=function(){return S("Query.toString",0,0,arguments.length),this.repo.toString()+this.path.toUrlEncodedString()},Mt.prototype.toJSON=function(){return S("Query.toJSON",0,1,arguments.length),this.toString()},Mt.prototype.queryObject=function(){return this.queryParams_.getQueryObject()},Mt.prototype.queryIdentifier=function(){var t=this.queryObject();t=Mn(t);return"{}"===t?"default":t},Mt.prototype.isEqual=function(t){if(S("Query.isEqual",1,1,arguments.length),!(t instanceof Mt))throw new Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.");var e=this.repo===t.repo,n=this.path.equals(t.path);t=this.queryIdentifier()===t.queryIdentifier();return e&&n&&t},Mt.getCancelAndContextArgs_=function(t,e,n){var r={cancel:null,context:null};if(e&&n)r.cancel=e,I(t,3,r.cancel,!0),r.context=n,N(t,4,r.context,!0);else if(e)if("object"==typeof e&&null!==e)r.context=e;else{if("function"!=typeof e)throw new Error(T(t,3,!0)+" must either be a cancel callback or a context object.");r.cancel=e}return r},Object.defineProperty(Mt.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0}),Mt),xr=(Wt.prototype.getImmediateChild=function(t){return new Wt(this.node_.getImmediateChild(t))},Wt.prototype.node=function(){return this.node_},Wt),kr=(Qt.prototype.getImmediateChild=function(t){return t=this.path_.child(t),new Qt(this.syncTree_,t)},Qt.prototype.node=function(){return this.syncTree_.calcCompleteEventCache(this.path_)},Qt),Ar=function(t,e,n){return t&&"object"==typeof t?(Ke(".sv"in t,"Unexpected leaf node or priority contents"),"string"==typeof t[".sv"]?Fr(t[".sv"],e,n):"object"==typeof t[".sv"]?Lr(t[".sv"],e):void Ke(!1,"Unexpected server value: "+JSON.stringify(t,null,2))):t},Fr=function(t,e,n){if("timestamp"===t)return n.timestamp;Ke(!1,"Unexpected server value: "+t)},Lr=function(t,e,n){return t.hasOwnProperty("increment")||Ke(!1,"Unexpected server value: "+JSON.stringify(t,null,2)),t=t.increment,"number"!=typeof t&&Ke(!1,"Unexpected increment value: "+t),e=e.node(),Ke(null!=e,"Expected ChildrenNode.EMPTY_NODE for nulls"),e.isLeafNode()?(e=e.getValue(),"number"!=typeof e?t:e+t):t},Mr=(Ht.prototype.find=function(t){if(null!=this.value)return this.value.getChild(t);if(!t.isEmpty()&&0<this.children.size){var e=t.getFront();return t=t.popFront(),this.children.has(e)?this.children.get(e).find(t):null}return null},Ht.prototype.remember=function(t,e){var n;t.isEmpty()?(this.value=e,this.children.clear()):null!==this.value?this.value=this.value.updateChild(t,e):(n=t.getFront(),this.children.has(n)||this.children.set(n,new Ht),n=this.children.get(n),t=t.popFront(),n.remember(t,e))},Ht.prototype.forget=function(t){if(t.isEmpty())return this.value=null,this.children.clear(),!0;if(null!==this.value){if(this.value.isLeafNode())return!1;var e=this.value;this.value=null;var n=this;return e.forEachChild(or,function(t,e){n.remember(new qn(t),e)}),this.forget(t)}return!(0<this.children.size)||(e=t.getFront(),t=t.popFront(),this.children.has(e)&&this.children.get(e).forget(t)&&this.children.delete(e),0===this.children.size)},Ht.prototype.forEachTree=function(t,e){null!==this.value?e(t,this.value):this.forEachChild(function(n,r){n=new qn(t.toString()+"/"+n),r.forEachTree(n,e)})},Ht.prototype.forEachChild=function(t){this.children.forEach(function(e,n){t(n,e)})},Ht);(er=br=br||{})[er.OVERWRITE=0]="OVERWRITE",er[er.MERGE=1]="MERGE",er[er.ACK_USER_WRITE=2]="ACK_USER_WRITE",er[er.LISTEN_COMPLETE=3]="LISTEN_COMPLETE";var Wr,Qr,qr=(jt.User=new jt(!0,!1,null,!1),jt.Server=new jt(!1,!0,null,!1),jt.forServerTaggedQuery=function(t){return new jt(!1,!0,t,!0)},jt),Ur=(Bt.prototype.operationForChild=function(t){if(this.path.isEmpty()){if(null!=this.affectedTree.value)return Ke(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var e=this.affectedTree.subtree(new qn(t));return new Bt(qn.Empty,e,this.revert)}return Ke(this.path.getFront()===t,"operationForChild called for unrelated child."),new Bt(this.path.popFront(),this.affectedTree,this.revert)},Bt),Vr=(zt.fromObject=function(t){var e=zt.Empty;return z(t,function(t,n){e=e.set(new qn(t),n)}),e},zt.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},zt.prototype.findRootMostMatchingPathAndValue=function(t,e){if(null!=this.value&&e(this.value))return{path:qn.Empty,value:this.value};if(t.isEmpty())return null;var n=t.getFront(),r=this.children.get(n);return null===r?null:(e=r.findRootMostMatchingPathAndValue(t.popFront(),e),null==e?null:{path:new qn(n).child(e.path),value:e.value})},zt.prototype.findRootMostValueAndPath=function(t){return this.findRootMostMatchingPathAndValue(t,function(){return!0})},zt.prototype.subtree=function(t){if(t.isEmpty())return this;var e=t.getFront();e=this.children.get(e);return null!==e?e.subtree(t.popFront()):zt.Empty},zt.prototype.set=function(t,e){if(t.isEmpty())return new zt(e,this.children);var n=t.getFront();e=(this.children.get(n)||zt.Empty).set(t.popFront(),e),e=this.children.insert(n,e);return new zt(this.value,e)},zt.prototype.remove=function(t){if(t.isEmpty())return this.children.isEmpty()?zt.Empty:new zt(null,this.children);var e=t.getFront(),n=this.children.get(e);return n?(n=n.remove(t.popFront()),t=void 0,t=n.isEmpty()?this.children.remove(e):this.children.insert(e,n),null===this.value&&t.isEmpty()?zt.Empty:new zt(this.value,t)):this},zt.prototype.get=function(t){if(t.isEmpty())return this.value;var e=t.getFront();e=this.children.get(e);return e?e.get(t.popFront()):null},zt.prototype.setTree=function(t,e){if(t.isEmpty())return e;var n=t.getFront();t=(this.children.get(n)||zt.Empty).setTree(t.popFront(),e),e=void 0,e=t.isEmpty()?this.children.remove(n):this.children.insert(n,t);return new zt(this.value,e)},zt.prototype.fold=function(t){return this.fold_(qn.Empty,t)},zt.prototype.fold_=function(t,e){var n={};return this.children.inorderTraversal(function(r,i){n[r]=i.fold_(t.child(r),e)}),e(t,this.value,n)},zt.prototype.findOnPath=function(t,e){return this.findOnPath_(t,qn.Empty,e)},zt.prototype.findOnPath_=function(t,e,n){var r=!!this.value&&n(e,this.value);if(r)return r;if(t.isEmpty())return null;var i=t.getFront();r=this.children.get(i);return r?r.findOnPath_(t.popFront(),e.child(i),n):null},zt.prototype.foreachOnPath=function(t,e){return this.foreachOnPath_(t,qn.Empty,e)},zt.prototype.foreachOnPath_=function(t,e,n){if(t.isEmpty())return this;this.value&&n(e,this.value);var r=t.getFront(),i=this.children.get(r);return i?i.foreachOnPath_(t.popFront(),e.child(r),n):zt.Empty},zt.prototype.foreach=function(t){this.foreach_(qn.Empty,t)},zt.prototype.foreach_=function(t,e){this.children.inorderTraversal(function(n,r){r.foreach_(t.child(n),e)}),this.value&&e(t,this.value)},zt.prototype.foreachChild=function(t){this.children.inorderTraversal(function(e,n){n.value&&t(e,n.value)})},zt.Empty=new zt(null),zt),Hr=(Kt.prototype.operationForChild=function(t){return this.path.isEmpty()?new Kt(this.source,qn.Empty):new Kt(this.source,this.path.popFront())},Kt),jr=(Yt.prototype.operationForChild=function(t){return this.path.isEmpty()?new Yt(this.source,qn.Empty,this.snap.getImmediateChild(t)):new Yt(this.source,this.path.popFront(),this.snap)},Yt),Br=(Gt.prototype.operationForChild=function(t){if(this.path.isEmpty()){var e=this.children.subtree(new qn(t));return e.isEmpty()?null:e.value?new jr(this.source,qn.Empty,e.value):new Gt(this.source,qn.Empty,e)}return Ke(this.path.getFront()===t,"Can't get a merge for a child not on the path of the operation"),new Gt(this.source,this.path.popFront(),this.children)},Gt.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},Gt),zr=(Xt.prototype.isFullyInitialized=function(){return this.fullyInitialized_},Xt.prototype.isFiltered=function(){return this.filtered_},Xt.prototype.isCompleteForPath=function(t){return t.isEmpty()?this.isFullyInitialized()&&!this.filtered_:(t=t.getFront(),this.isCompleteForChild(t))},Xt.prototype.isCompleteForChild=function(t){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(t)},Xt.prototype.getNode=function(){return this.node_},Xt),Kr=($t.prototype.updateEventSnap=function(t,e,n){return new $t(new zr(t,e,n),this.serverCache_)},$t.prototype.updateServerSnap=function(t,e,n){return new $t(this.eventCache_,new zr(t,e,n))},$t.prototype.getEventCache=function(){return this.eventCache_},$t.prototype.getCompleteEventSnap=function(){return this.eventCache_.isFullyInitialized()?this.eventCache_.getNode():null},$t.prototype.getServerCache=function(){return this.serverCache_},$t.prototype.getCompleteServerSnap=function(){return this.serverCache_.isFullyInitialized()?this.serverCache_.getNode():null},$t.Empty=new $t(new zr(gr.EMPTY_NODE,!1,!1),new zr(gr.EMPTY_NODE,!1,!1)),$t),Yr=(Jt.valueChange=function(t){return new Jt(Jt.VALUE,t)},Jt.childAddedChange=function(t,e){return new Jt(Jt.CHILD_ADDED,e,t)},Jt.childRemovedChange=function(t,e){return new Jt(Jt.CHILD_REMOVED,e,t)},Jt.childChangedChange=function(t,e,n){return new Jt(Jt.CHILD_CHANGED,e,t,n)},Jt.childMovedChange=function(t,e){return new Jt(Jt.CHILD_MOVED,e,t)},Jt.CHILD_ADDED="child_added",Jt.CHILD_REMOVED="child_removed",Jt.CHILD_CHANGED="child_changed",Jt.CHILD_MOVED="child_moved",Jt.VALUE="value",Jt),Gr=(Zt.prototype.updateChild=function(t,e,n,r,i,o){Ke(t.isIndexed(this.index_),"A node must be indexed if only a child is updated");var s=t.getImmediateChild(e);return s.getChild(r).equals(n.getChild(r))&&s.isEmpty()===n.isEmpty()?t:(null!=o&&(n.isEmpty()?t.hasChild(e)?o.trackChildChange(Yr.childRemovedChange(e,s)):Ke(t.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):s.isEmpty()?o.trackChildChange(Yr.childAddedChange(e,n)):o.trackChildChange(Yr.childChangedChange(e,n,s))),t.isLeafNode()&&n.isEmpty()?t:t.updateImmediateChild(e,n).withIndex(this.index_))},Zt.prototype.updateFullNode=function(t,e,n){return null!=n&&(t.isLeafNode()||t.forEachChild(or,function(t,r){e.hasChild(t)||n.trackChildChange(Yr.childRemovedChange(t,r))}),e.isLeafNode()||e.forEachChild(or,function(e,r){var i;t.hasChild(e)?(i=t.getImmediateChild(e)).equals(r)||n.trackChildChange(Yr.childChangedChange(e,r,i)):n.trackChildChange(Yr.childAddedChange(e,r))})),e.withIndex(this.index_)},Zt.prototype.updatePriority=function(t,e){return t.isEmpty()?gr.EMPTY_NODE:t.updatePriority(e)},Zt.prototype.filtersNodes=function(){return!1},Zt.prototype.getIndexedFilter=function(){return this},Zt.prototype.getIndex=function(){return this.index_},Zt),Xr=(te.prototype.trackChildChange=function(t){var e=t.type,n=t.childName;Ke(e===Yr.CHILD_ADDED||e===Yr.CHILD_CHANGED||e===Yr.CHILD_REMOVED,"Only child changes supported for tracking"),Ke(".priority"!==n,"Only non-priority child changes can be tracked.");var r=this.changeMap.get(n);if(r){var i=r.type;if(e===Yr.CHILD_ADDED&&i===Yr.CHILD_REMOVED)this.changeMap.set(n,Yr.childChangedChange(n,t.snapshotNode,r.snapshotNode));else if(e===Yr.CHILD_REMOVED&&i===Yr.CHILD_ADDED)this.changeMap.delete(n);else if(e===Yr.CHILD_REMOVED&&i===Yr.CHILD_CHANGED)this.changeMap.set(n,Yr.childRemovedChange(n,r.oldSnap));else if(e===Yr.CHILD_CHANGED&&i===Yr.CHILD_ADDED)this.changeMap.set(n,Yr.childAddedChange(n,t.snapshotNode));else{if(e!==Yr.CHILD_CHANGED||i!==Yr.CHILD_CHANGED)throw Ye("Illegal combination of changes: "+t+" occurred after "+r);this.changeMap.set(n,Yr.childChangedChange(n,t.snapshotNode,r.oldSnap))}}else this.changeMap.set(n,t)},te.prototype.getChanges=function(){return Array.from(this.changeMap.values())},te),$r=new(ee.prototype.getCompleteChild=function(t){return null},ee.prototype.getChildAfterChild=function(t,e,n){return null},ee),Jr=(ne.prototype.getCompleteChild=function(t){var e=this.viewCache_.getEventCache();return e.isCompleteForChild(t)?e.getNode().getImmediateChild(t):(e=null!=this.optCompleteServerCache_?new zr(this.optCompleteServerCache_,!0,!1):this.viewCache_.getServerCache(),this.writes_.calcCompleteChild(t,e))},ne.prototype.getChildAfterChild=function(t,e,n){var r=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:this.viewCache_.getCompleteServerSnap();t=this.writes_.calcIndexedSlice(r,e,1,n,t);return 0===t.length?null:t[0]},ne),Zr=function(t,e){this.viewCache=t,this.changes=e},ti=(re.prototype.assertIndexed=function(t){Ke(t.getEventCache().getNode().isIndexed(this.filter_.getIndex()),"Event snap not indexed"),Ke(t.getServerCache().getNode().isIndexed(this.filter_.getIndex()),"Server snap not indexed")},re.prototype.applyOperation=function(t,e,n,r){var i=new Xr;if(e.type===br.OVERWRITE)var o=e,s=o.source.fromUser?this.applyUserOverwrite_(t,o.path,o.snap,n,r,i):(Ke(o.source.fromServer,"Unknown source."),a=o.source.tagged||t.getServerCache().isFiltered()&&!o.path.isEmpty(),this.applyServerOverwrite_(t,o.path,o.snap,n,r,a,i));else if(e.type===br.MERGE)o=e,s=o.source.fromUser?this.applyUserMerge_(t,o.path,o.children,n,r,i):(Ke(o.source.fromServer,"Unknown source."),a=o.source.tagged||t.getServerCache().isFiltered(),this.applyServerMerge_(t,o.path,o.children,n,r,a,i));else if(e.type===br.ACK_USER_WRITE){var a=e;s=a.revert?this.revertUserWrite_(t,a.path,n,r,i):this.ackUserWrite_(t,a.path,a.affectedTree,n,r,i)}else{if(e.type!==br.LISTEN_COMPLETE)throw Ye("Unknown operation type: "+e.type);s=this.listenComplete_(t,e.path,n,i)}return i=i.getChanges(),re.maybeAddValueEvent_(t,s,i),new Zr(s,i)},re.maybeAddValueEvent_=function(t,e,n){var r,i,o=e.getEventCache();o.isFullyInitialized()&&(r=o.getNode().isLeafNode()||o.getNode().isEmpty(),i=t.getCompleteEventSnap(),(0<n.length||!t.getEventCache().isFullyInitialized()||r&&!o.getNode().equals(i)||!o.getNode().getPriority().equals(i.getPriority()))&&n.push(Yr.valueChange(e.getCompleteEventSnap())))},re.prototype.generateEventCacheAfterServerEvent_=function(t,e,n,r,i){var o=t.getEventCache();if(null!=n.shadowingWrite(e))return t;var s,a,h,l,u=void 0,c=void 0;return u=e.isEmpty()?(Ke(t.getServerCache().isFullyInitialized(),"If change path is empty, we must have complete server data"),t.getServerCache().isFiltered()?(s=(s=t.getCompleteServerSnap())instanceof gr?s:gr.EMPTY_NODE,s=n.calcCompleteEventChildren(s),this.filter_.updateFullNode(t.getEventCache().getNode(),s,i)):(a=n.calcCompleteEventCache(t.getCompleteServerSnap()),this.filter_.updateFullNode(t.getEventCache().getNode(),a,i))):".priority"===(a=e.getFront())?(Ke(1===e.getLength(),"Can't have a priority with additional path components"),h=o.getNode(),c=t.getServerCache().getNode(),null!=(l=n.calcEventCacheAfterServerOverwrite(e,h,c))?this.filter_.updatePriority(h,l):o.getNode()):(h=e.popFront(),l=void 0,null!=(l=o.isCompleteForChild(a)?(c=t.getServerCache().getNode(),null!=(c=n.calcEventCacheAfterServerOverwrite(e,o.getNode(),c))?o.getNode().getImmediateChild(a).updateChild(h,c):o.getNode().getImmediateChild(a)):n.calcCompleteChild(a,t.getServerCache()))?this.filter_.updateChild(o.getNode(),a,l,h,r,i):o.getNode()),t.updateEventSnap(u,o.isFullyInitialized()||e.isEmpty(),this.filter_.filtersNodes())},re.prototype.applyServerOverwrite_=function(t,e,n,r,i,o,s){var a=t.getServerCache(),h=o?this.filter_:this.filter_.getIndexedFilter();if(e.isEmpty())u=h.updateFullNode(a.getNode(),n,null);else if(h.filtersNodes()&&!a.isFiltered())var l=a.getNode().updateChild(e,n),u=h.updateFullNode(a.getNode(),l,null);else{if(o=e.getFront(),!a.isCompleteForPath(e)&&1<e.getLength())return t;l=e.popFront(),n=a.getNode().getImmediateChild(o).updateChild(l,n),u=".priority"===o?h.updatePriority(a.getNode(),n):h.updateChild(a.getNode(),o,n,l,$r,null)}return h=t.updateServerSnap(u,a.isFullyInitialized()||e.isEmpty(),h.filtersNodes()),i=new Jr(r,h,i),this.generateEventCacheAfterServerEvent_(h,e,r,i,s)},re.prototype.applyUserOverwrite_=function(t,e,n,r,i,o){var s,a,h=t.getEventCache(),l=new Jr(r,t,i);return e.isEmpty()?(a=this.filter_.updateFullNode(t.getEventCache().getNode(),n,o),t.updateEventSnap(a,!0,this.filter_.filtersNodes())):".priority"===(s=e.getFront())?(a=this.filter_.updatePriority(t.getEventCache().getNode(),n),t.updateEventSnap(a,h.isFullyInitialized(),h.isFiltered())):(r=e.popFront(),i=h.getNode().getImmediateChild(s),a=void 0,a=r.isEmpty()?n:null!=(e=l.getCompleteChild(s))?".priority"===r.getBack()&&e.getChild(r.parent()).isEmpty()?e:e.updateChild(r,n):gr.EMPTY_NODE,i.equals(a)?t:(o=this.filter_.updateChild(h.getNode(),s,a,r,l,o),t.updateEventSnap(o,h.isFullyInitialized(),this.filter_.filtersNodes())))},re.cacheHasChild_=function(t,e){return t.getEventCache().isCompleteForChild(e)},re.prototype.applyUserMerge_=function(t,e,n,r,i,o){var s=this,a=t;return n.foreach(function(n,h){n=e.child(n),re.cacheHasChild_(t,n.getFront())&&(a=s.applyUserOverwrite_(a,n,h,r,i,o))}),n.foreach(function(n,h){n=e.child(n),re.cacheHasChild_(t,n.getFront())||(a=s.applyUserOverwrite_(a,n,h,r,i,o))}),a},re.prototype.applyMerge_=function(t,e){return e.foreach(function(e,n){t=t.updateChild(e,n)}),t},re.prototype.applyServerMerge_=function(t,e,n,r,i,o,s){var a=this;if(t.getServerCache().getNode().isEmpty()&&!t.getServerCache().isFullyInitialized())return t;var h=t,l=(n=e.isEmpty()?n:Vr.Empty.setTree(e,n),t.getServerCache().getNode());return n.children.inorderTraversal(function(e,n){var u;l.hasChild(e)&&(u=t.getServerCache().getNode().getImmediateChild(e),n=a.applyMerge_(u,n),h=a.applyServerOverwrite_(h,new qn(e),n,r,i,o,s))}),n.children.inorderTraversal(function(e,n){var u=!t.getServerCache().isCompleteForChild(e)&&null==n.value;l.hasChild(e)||u||(u=t.getServerCache().getNode().getImmediateChild(e),n=a.applyMerge_(u,n),h=a.applyServerOverwrite_(h,new qn(e),n,r,i,o,s))}),h},re.prototype.ackUserWrite_=function(t,e,n,r,i,o){if(null!=r.shadowingWrite(e))return t;var s=t.getServerCache().isFiltered(),a=t.getServerCache();if(null!=n.value){if(e.isEmpty()&&a.isFullyInitialized()||a.isCompleteForPath(e))return this.applyServerOverwrite_(t,e,a.getNode().getChild(e),r,i,s,o);if(e.isEmpty()){var h=Vr.Empty;return a.getNode().forEachChild(nr,function(t,e){h=h.set(new qn(t),e)}),this.applyServerMerge_(t,e,h,r,i,s,o)}return t}var l=Vr.Empty;return n.foreach(function(t,n){var r=e.child(t);a.isCompleteForPath(r)&&(l=l.set(t,a.getNode().getChild(r)))}),this.applyServerMerge_(t,e,l,r,i,s,o)},re.prototype.listenComplete_=function(t,e,n,r){var i=t.getServerCache();i=t.updateServerSnap(i.getNode(),i.isFullyInitialized()||e.isEmpty(),i.isFiltered());return this.generateEventCacheAfterServerEvent_(i,e,n,$r,r)},re.prototype.revertUserWrite_=function(t,e,n,r,i){var o;if(null!=n.shadowingWrite(e))return t;var s,a,h=new Jr(n,t,r),l=t.getEventCache().getNode();r=void 0;return e.isEmpty()||".priority"===e.getFront()?(a=void 0,a=t.getServerCache().isFullyInitialized()?n.calcCompleteEventCache(t.getCompleteServerSnap()):(s=t.getServerCache().getNode(),Ke(s instanceof gr,"serverChildren would be complete if leaf node"),n.calcCompleteEventChildren(s)),r=this.filter_.updateFullNode(l,a,i)):(s=e.getFront(),null==(a=n.calcCompleteChild(s,t.getServerCache()))&&t.getServerCache().isCompleteForChild(s)&&(a=l.getImmediateChild(s)),
(r=null!=a?this.filter_.updateChild(l,s,a,e.popFront(),h,i):t.getEventCache().getNode().hasChild(s)?this.filter_.updateChild(l,s,gr.EMPTY_NODE,e.popFront(),h,i):l).isEmpty()&&t.getServerCache().isFullyInitialized()&&(o=n.calcCompleteEventCache(t.getCompleteServerSnap())).isLeafNode()&&(r=this.filter_.updateFullNode(r,o,i))),o=t.getServerCache().isFullyInitialized()||null!=n.shadowingWrite(qn.Empty),t.updateEventSnap(r,o,this.filter_.filtersNodes())},re),ei=(ie.prototype.generateEventsForChanges=function(t,e,n){var r=this,i=[],o=[];return t.forEach(function(t){t.type===Yr.CHILD_CHANGED&&r.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&o.push(Yr.childMovedChange(t.childName,t.snapshotNode))}),this.generateEventsForType_(i,Yr.CHILD_REMOVED,t,n,e),this.generateEventsForType_(i,Yr.CHILD_ADDED,t,n,e),this.generateEventsForType_(i,Yr.CHILD_MOVED,o,n,e),this.generateEventsForType_(i,Yr.CHILD_CHANGED,t,n,e),this.generateEventsForType_(i,Yr.VALUE,t,n,e),i},ie.prototype.generateEventsForType_=function(t,e,n,r,i){var o=this;n=n.filter(function(t){return t.type===e});n.sort(this.compareChanges_.bind(this)),n.forEach(function(e){var n=o.materializeSingleChange_(e,i);r.forEach(function(r){r.respondsTo(e.type)&&t.push(r.createEvent(n,o.query_))})})},ie.prototype.materializeSingleChange_=function(t,e){return"value"===t.type||"child_removed"===t.type||(t.prevName=e.getPredecessorChildName(t.childName,t.snapshotNode,this.index_)),t},ie.prototype.compareChanges_=function(t,e){if(null==t.childName||null==e.childName)throw Ye("Should only compare child_ events.");return t=new tr(t.childName,t.snapshotNode),e=new tr(e.childName,e.snapshotNode),this.index_.compare(t,e)},ie),ni=(oe.prototype.getQuery=function(){return this.query_},oe.prototype.getServerCache=function(){return this.viewCache_.getServerCache().getNode()},oe.prototype.getCompleteServerCache=function(t){var e=this.viewCache_.getCompleteServerSnap();return e&&(this.query_.getQueryParams().loadsAllData()||!t.isEmpty()&&!e.getImmediateChild(t.getFront()).isEmpty())?e.getChild(t):null},oe.prototype.isEmpty=function(){return 0===this.eventRegistrations_.length},oe.prototype.addEventRegistration=function(t){this.eventRegistrations_.push(t)},oe.prototype.removeEventRegistration=function(t,e){var n,r=[];if(e&&(Ke(null==t,"A cancel should cancel all event registrations."),n=this.query_.path,this.eventRegistrations_.forEach(function(t){t=t.createCancelEvent(e,n),t&&r.push(t)})),t){for(var i=[],o=0;o<this.eventRegistrations_.length;++o){var s=this.eventRegistrations_[o];if(s.matches(t)){if(t.hasAnyCallback()){i=i.concat(this.eventRegistrations_.slice(o+1));break}}else i.push(s)}this.eventRegistrations_=i}else this.eventRegistrations_=[];return r},oe.prototype.applyOperation=function(t,e,n){t.type===br.MERGE&&null!==t.source.queryId&&(Ke(this.viewCache_.getCompleteServerSnap(),"We should always have a full cache before handling merges"),Ke(this.viewCache_.getCompleteEventSnap(),"Missing event cache, even though we have a server cache"));var r=this.viewCache_;n=this.processor_.applyOperation(r,t,e,n);return this.processor_.assertIndexed(n.viewCache),Ke(n.viewCache.getServerCache().isFullyInitialized()||!r.getServerCache().isFullyInitialized(),"Once a server snap is complete, it should never go back"),this.viewCache_=n.viewCache,this.generateEventsForChanges_(n.changes,n.viewCache.getEventCache().getNode(),null)},oe.prototype.getInitialEvents=function(t){var e=this.viewCache_.getEventCache(),n=[];return e.getNode().isLeafNode()||e.getNode().forEachChild(or,function(t,e){n.push(Yr.childAddedChange(t,e))}),e.isFullyInitialized()&&n.push(Yr.valueChange(e.getNode())),this.generateEventsForChanges_(n,e.getNode(),t)},oe.prototype.generateEventsForChanges_=function(t,e,n){return n=n?[n]:this.eventRegistrations_,this.eventGenerator_.generateEventsForChanges(t,e,n)},oe),ri=(Object.defineProperty(se,"__referenceConstructor",{get:function(){return Ke(Qr,"Reference.ts has not been loaded"),Qr},set:function(t){Ke(!Qr,"__referenceConstructor has already been defined"),Qr=t},enumerable:!1,configurable:!0}),se.prototype.isEmpty=function(){return 0===this.views.size},se.prototype.applyOperation=function(t,e,n){var r,i,s=t.source.queryId;if(null!==s){var a=this.views.get(s);return Ke(null!=a,"SyncTree gave us an op for an invalid query."),a.applyOperation(t,e,n)}var h=[];try{for(var l=o(this.views.values()),u=l.next();!u.done;u=l.next())a=u.value,h=h.concat(a.applyOperation(t,e,n))}catch(t){r={error:t}}finally{try{u&&!u.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}return h},se.prototype.addEventRegistration=function(t,e,n,r,i){var o,s,a=t.queryIdentifier(),h=this.views.get(a);return h||(s=!1,s=!!(o=n.calcCompleteEventCache(i?r:null))||(o=r instanceof gr?n.calcCompleteEventChildren(r):gr.EMPTY_NODE,!1),i=new Kr(new zr(o,s,!1),new zr(r,i,!1)),h=new ni(t,i),this.views.set(a,h)),h.addEventRegistration(e),h.getInitialEvents(e)},se.prototype.removeEventRegistration=function(t,e,n){var r,i,a=t.queryIdentifier(),h=[],l=[],u=this.hasCompleteView();if("default"===a)try{for(var c=o(this.views.entries()),p=c.next();!p.done;p=c.next()){var d=s(p.value,2),f=d[0],_=d[1];l=l.concat(_.removeEventRegistration(e,n));_.isEmpty()&&(this.views.delete(f),_.getQuery().getQueryParams().loadsAllData()||h.push(_.getQuery()))}}catch(t){r={error:t}}finally{try{p&&!p.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}else(_=this.views.get(a))&&(l=l.concat(_.removeEventRegistration(e,n)),_.isEmpty()&&(this.views.delete(a),_.getQuery().getQueryParams().loadsAllData()||h.push(_.getQuery())));return u&&!this.hasCompleteView()&&h.push(new se.__referenceConstructor(t.repo,t.path)),{removed:h,events:l}},se.prototype.getQueryViews=function(){var t,e,n=[];try{for(var r=o(this.views.values()),i=r.next();!i.done;i=r.next()){var s=i.value;s.getQuery().getQueryParams().loadsAllData()||n.push(s)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},se.prototype.getCompleteServerCache=function(t){var e,n,r=null;try{for(var i=o(this.views.values()),s=i.next();!s.done;s=i.next()){var a=s.value;r=r||a.getCompleteServerCache(t)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},se.prototype.viewForQuery=function(t){return t.getQueryParams().loadsAllData()?this.getCompleteView():(t=t.queryIdentifier(),this.views.get(t))},se.prototype.viewExistsForQuery=function(t){return null!=this.viewForQuery(t)},se.prototype.hasCompleteView=function(){return null!=this.getCompleteView()},se.prototype.getCompleteView=function(){var t,e;try{for(var n=o(this.views.values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.getQuery().getQueryParams().loadsAllData())return i}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}return null},se),ii=(ae.prototype.addWrite=function(t,e){if(t.isEmpty())return new ae(new Vr(e));var n=this.writeTree_.findRootMostValueAndPath(t);if(null!=n){var r=n.path,i=n.value;n=qn.relativePath(r,t),i=i.updateChild(n,e);return new ae(this.writeTree_.set(r,i))}return e=new Vr(e),new ae(this.writeTree_.setTree(t,e))},ae.prototype.addWrites=function(t,e){var n=this;return z(e,function(e,r){n=n.addWrite(t.child(e),r)}),n},ae.prototype.removeWrite=function(t){return t.isEmpty()?ae.Empty:new ae(this.writeTree_.setTree(t,Vr.Empty))},ae.prototype.hasCompleteWrite=function(t){return null!=this.getCompleteNode(t)},ae.prototype.getCompleteNode=function(t){var e=this.writeTree_.findRootMostValueAndPath(t);return null!=e?this.writeTree_.get(e.path).getChild(qn.relativePath(e.path,t)):null},ae.prototype.getCompleteChildren=function(){var t=[],e=this.writeTree_.value;return null!=e?e.isLeafNode()||e.forEachChild(or,function(e,n){t.push(new tr(e,n))}):this.writeTree_.children.inorderTraversal(function(e,n){null!=n.value&&t.push(new tr(e,n.value))}),t},ae.prototype.childCompoundWrite=function(t){if(t.isEmpty())return this;var e=this.getCompleteNode(t);return new ae(null!=e?new Vr(e):this.writeTree_.subtree(t))},ae.prototype.isEmpty=function(){return this.writeTree_.isEmpty()},ae.prototype.apply=function(t){return function t(e,n,r){if(null!=n.value)return r.updateChild(e,n.value);var i=null;return n.children.inorderTraversal(function(n,o){".priority"===n?(Ke(null!==o.value,"Priority writes must always be leaf nodes"),i=o.value):r=t(e.child(n),o,r)}),r.getChild(e).isEmpty()||null===i||(r=r.updateChild(e.child(".priority"),i)),r}(qn.Empty,this.writeTree_,t)},ae.Empty=new ae(new Vr(null)),ae),oi=(he.prototype.childWrites=function(t){return new si(t,this)},he.prototype.addOverwrite=function(t,e,n,r){Ke(n>this.lastWriteId_,"Stacking an older write on top of newer ones"),void 0===r&&(r=!0),this.allWrites_.push({path:t,snap:e,writeId:n,visible:r}),r&&(this.visibleWrites_=this.visibleWrites_.addWrite(t,e)),this.lastWriteId_=n},he.prototype.addMerge=function(t,e,n){Ke(n>this.lastWriteId_,"Stacking an older merge on top of newer ones"),this.allWrites_.push({path:t,children:e,writeId:n,visible:!0}),this.visibleWrites_=this.visibleWrites_.addWrites(t,e),this.lastWriteId_=n},he.prototype.getWrite=function(t){for(var e=0;e<this.allWrites_.length;e++){var n=this.allWrites_[e];if(n.writeId===t)return n}return null},he.prototype.removeWrite=function(t){var e=this,n=this.allWrites_.findIndex(function(e){return e.writeId===t});Ke(0<=n,"removeWrite called with nonexistent writeId.");var r=this.allWrites_[n];this.allWrites_.splice(n,1);for(var i=r.visible,o=!1,s=this.allWrites_.length-1;i&&0<=s;){var a=this.allWrites_[s];a.visible&&(n<=s&&this.recordContainsPath_(a,r.path)?i=!1:r.path.contains(a.path)&&(o=!0)),s--}return!!i&&(o?this.resetTree_():r.snap?this.visibleWrites_=this.visibleWrites_.removeWrite(r.path):z(r.children,function(t){e.visibleWrites_=e.visibleWrites_.removeWrite(r.path.child(t))}),!0)},he.prototype.getCompleteWriteData=function(t){return this.visibleWrites_.getCompleteNode(t)},he.prototype.calcCompleteEventCache=function(t,e,n,r){if(n||r){var i=this.visibleWrites_.childCompoundWrite(t);if(!r&&i.isEmpty())return e;if(r||null!=e||i.hasCompleteWrite(qn.Empty)){var o=he.layerTree_(this.allWrites_,function(e){return(e.visible||r)&&(!n||!~n.indexOf(e.writeId))&&(e.path.contains(t)||t.contains(e.path))},t),s=e||gr.EMPTY_NODE;return o.apply(s)}return null}if(o=this.visibleWrites_.getCompleteNode(t),null!=o)return o;if(o=this.visibleWrites_.childCompoundWrite(t),o.isEmpty())return e;if(null!=e||o.hasCompleteWrite(qn.Empty)){s=e||gr.EMPTY_NODE;return o.apply(s)}return null},he.prototype.calcCompleteEventChildren=function(t,e){var n=gr.EMPTY_NODE,r=this.visibleWrites_.getCompleteNode(t);if(r)return r.isLeafNode()||r.forEachChild(or,function(t,e){n=n.updateImmediateChild(t,e)}),n;if(e){var i=this.visibleWrites_.childCompoundWrite(t);return e.forEachChild(or,function(t,e){e=i.childCompoundWrite(new qn(t)).apply(e),n=n.updateImmediateChild(t,e)}),i.getCompleteChildren().forEach(function(t){n=n.updateImmediateChild(t.name,t.node)}),n}return this.visibleWrites_.childCompoundWrite(t).getCompleteChildren().forEach(function(t){n=n.updateImmediateChild(t.name,t.node)}),n},he.prototype.calcEventCacheAfterServerOverwrite=function(t,e,n,r){return Ke(n||r,"Either existingEventSnap or existingServerSnap must exist"),t=t.child(e),this.visibleWrites_.hasCompleteWrite(t)?null:(t=this.visibleWrites_.childCompoundWrite(t),t.isEmpty()?r.getChild(e):t.apply(r.getChild(e)))},he.prototype.calcCompleteChild=function(t,e,n){var r=t.child(e);t=this.visibleWrites_.getCompleteNode(r);return null!=t?t:n.isCompleteForChild(e)?this.visibleWrites_.childCompoundWrite(r).apply(n.getNode().getImmediateChild(e)):null},he.prototype.shadowingWrite=function(t){return this.visibleWrites_.getCompleteNode(t)},he.prototype.calcIndexedSlice=function(t,e,n,r,i,o){var s,a=this.visibleWrites_.childCompoundWrite(t);t=a.getCompleteNode(qn.Empty);if(null!=t)s=t;else{if(null==e)return[];s=a.apply(e)}if((s=s.withIndex(o)).isEmpty()||s.isLeafNode())return[];for(var h=[],l=o.getCompare(),u=i?s.getReverseIteratorFrom(n,o):s.getIteratorFrom(n,o),c=u.getNext();c&&h.length<r;)0!==l(c,n)&&h.push(c),c=u.getNext();return h},he.prototype.recordContainsPath_=function(t,e){if(t.snap)return t.path.contains(e);for(var n in t.children)if(t.children.hasOwnProperty(n)&&t.path.child(n).contains(e))return!0;return!1},he.prototype.resetTree_=function(){this.visibleWrites_=he.layerTree_(this.allWrites_,he.DefaultFilter_,qn.Empty),0<this.allWrites_.length?this.lastWriteId_=this.allWrites_[this.allWrites_.length-1].writeId:this.lastWriteId_=-1},he.DefaultFilter_=function(t){return t.visible},he.layerTree_=function(t,e,n){for(var r=ii.Empty,i=0;i<t.length;++i){var o=t[i];if(e(o)){var s=o.path,a=void 0;if(o.snap)n.contains(s)?(a=qn.relativePath(n,s),r=r.addWrite(a,o.snap)):s.contains(n)&&(a=qn.relativePath(s,n),r=r.addWrite(qn.Empty,o.snap.getChild(a)));else{if(!o.children)throw Ye("WriteRecord should have .snap or .children");n.contains(s)?(a=qn.relativePath(n,s),r=r.addWrites(a,o.children)):s.contains(n)&&((a=qn.relativePath(s,n)).isEmpty()?r=r.addWrites(qn.Empty,o.children):(o=C(o.children,a.getFront()))&&(a=o.getChild(a.popFront()),r=r.addWrite(qn.Empty,a)))}}}return r},he),si=(le.prototype.calcCompleteEventCache=function(t,e,n){return this.writeTree_.calcCompleteEventCache(this.treePath_,t,e,n)},le.prototype.calcCompleteEventChildren=function(t){return this.writeTree_.calcCompleteEventChildren(this.treePath_,t)},le.prototype.calcEventCacheAfterServerOverwrite=function(t,e,n){return this.writeTree_.calcEventCacheAfterServerOverwrite(this.treePath_,t,e,n)},le.prototype.shadowingWrite=function(t){return this.writeTree_.shadowingWrite(this.treePath_.child(t))},le.prototype.calcIndexedSlice=function(t,e,n,r,i){return this.writeTree_.calcIndexedSlice(this.treePath_,t,e,n,r,i)},le.prototype.calcCompleteChild=function(t,e){return this.writeTree_.calcCompleteChild(this.treePath_,t,e)},le.prototype.child=function(t){return new le(this.treePath_.child(t),this.writeTree_)},le),ai=(ue.prototype.applyUserOverwrite=function(t,e,n,r){return this.pendingWriteTree_.addOverwrite(t,e,n,r),r?this.applyOperationToSyncPoints_(new jr(qr.User,t,e)):[]},ue.prototype.applyUserMerge=function(t,e,n){return this.pendingWriteTree_.addMerge(t,e,n),e=Vr.fromObject(e),this.applyOperationToSyncPoints_(new Br(qr.User,t,e))},ue.prototype.ackUserWrite=function(t,e){void 0===e&&(e=!1);var n=this.pendingWriteTree_.getWrite(t);if(this.pendingWriteTree_.removeWrite(t)){var r=Vr.Empty;return null!=n.snap?r=r.set(qn.Empty,!0):z(n.children,function(t,e){r=r.set(new qn(t),e)}),this.applyOperationToSyncPoints_(new Ur(n.path,r,e))}return[]},ue.prototype.applyServerOverwrite=function(t,e){return this.applyOperationToSyncPoints_(new jr(qr.Server,t,e))},ue.prototype.applyServerMerge=function(t,e){return e=Vr.fromObject(e),this.applyOperationToSyncPoints_(new Br(qr.Server,t,e))},ue.prototype.applyListenComplete=function(t){return this.applyOperationToSyncPoints_(new Hr(qr.Server,t))},ue.prototype.applyTaggedQueryOverwrite=function(t,e,n){var r=this.queryKeyForTag_(n);return null==r?[]:(n=ue.parseQueryKey_(r),r=n.path,n=n.queryId,t=qn.relativePath(r,t),e=new jr(qr.forServerTaggedQuery(n),t,e),this.applyTaggedOperation_(r,e))},ue.prototype.applyTaggedQueryMerge=function(t,e,n){var r=this.queryKeyForTag_(n);return r?(n=ue.parseQueryKey_(r),r=n.path,n=n.queryId,t=qn.relativePath(r,t),e=Vr.fromObject(e),e=new Br(qr.forServerTaggedQuery(n),t,e),this.applyTaggedOperation_(r,e)):[]},ue.prototype.applyTaggedListenComplete=function(t,e){var n=this.queryKeyForTag_(e);return n?(e=ue.parseQueryKey_(n),n=e.path,e=e.queryId,t=qn.relativePath(n,t),t=new Hr(qr.forServerTaggedQuery(e),t),this.applyTaggedOperation_(n,t)):[]},ue.prototype.addEventRegistration=function(t,e){var n=t.path,r=null,i=!1;this.syncPointTree_.foreachOnPath(n,function(t,e){t=qn.relativePath(t,n),r=r||e.getCompleteServerCache(t),i=i||e.hasCompleteView()});var o=this.syncPointTree_.get(n);o?(i=i||o.hasCompleteView(),r=r||o.getCompleteServerCache(qn.Empty)):(o=new ri,this.syncPointTree_=this.syncPointTree_.set(n,o)),null!=r?l=!0:(l=!1,r=gr.EMPTY_NODE,this.syncPointTree_.subtree(n).foreachChild(function(t,e){e=e.getCompleteServerCache(qn.Empty),e&&(r=r.updateImmediateChild(t,e))}));var s,a=o.viewExistsForQuery(t);a||t.getQueryParams().loadsAllData()||(h=ue.makeQueryKey_(t),Ke(!this.queryToTagMap.has(h),"View does not exist, but we have a tag"),s=ue.getNextQueryTag_(),this.queryToTagMap.set(h,s),this.tagToQueryMap.set(s,h));var h=this.pendingWriteTree_.childWrites(n),l=o.addEventRegistration(t,e,h,r,l);return a||i||(o=o.viewForQuery(t),l=l.concat(this.setupListener_(t,o))),l},ue.prototype.removeEventRegistration=function(t,e,n){var r=this,i=t.path,o=this.syncPointTree_.get(i),s=[];if(o&&("default"===t.queryIdentifier()||o.viewExistsForQuery(t))){var a=o.removeEventRegistration(t,e,n);if(o.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(i)),e=a.removed,s=a.events,o=-1!==e.findIndex(function(t){return t.getQueryParams().loadsAllData()}),a=this.syncPointTree_.findOnPath(i,function(t,e){return e.hasCompleteView()}),o&&!a&&(i=this.syncPointTree_.subtree(i),!i.isEmpty()))for(var h=this.collectDistinctViewsForSubTree_(i),l=0;l<h.length;++l){var u=h[l],c=u.getQuery();u=this.createListenerForView_(u);this.listenProvider_.startListening(ue.queryForListening_(c),this.tagForQuery_(c),u.hashFn,u.onComplete)}!a&&0<e.length&&!n&&(o?this.listenProvider_.stopListening(ue.queryForListening_(t),null):e.forEach(function(t){var e=r.queryToTagMap.get(ue.makeQueryKey_(t));r.listenProvider_.stopListening(ue.queryForListening_(t),e)})),this.removeTags_(e)}return s},ue.prototype.calcCompleteEventCache=function(t,e){var n=this.pendingWriteTree_,r=this.syncPointTree_.findOnPath(t,function(e,n){if(e=qn.relativePath(e,t),e=n.getCompleteServerCache(e),e)return e});return n.calcCompleteEventCache(t,r,e,!0)},ue.prototype.collectDistinctViewsForSubTree_=function(t){return t.fold(function(t,e,n){if(e&&e.hasCompleteView())return[e.getCompleteView()];var r=[];return e&&(r=e.getQueryViews()),z(n,function(t,e){r=r.concat(e)}),r})},ue.prototype.removeTags_=function(t){for(var e=0;e<t.length;++e){var n,r=t[e];r.getQueryParams().loadsAllData()||(n=ue.makeQueryKey_(r),r=this.queryToTagMap.get(n),this.queryToTagMap.delete(n),this.tagToQueryMap.delete(r))}},ue.queryForListening_=function(t){return t.getQueryParams().loadsAllData()&&!t.getQueryParams().isDefault()?t.getRef():t},ue.prototype.setupListener_=function(t,e){var n=t.path,r=this.tagForQuery_(t);e=this.createListenerForView_(e),e=this.listenProvider_.startListening(ue.queryForListening_(t),r,e.hashFn,e.onComplete),n=this.syncPointTree_.subtree(n);if(r)Ke(!n.value.hasCompleteView(),"If we're adding a query, it shouldn't be shadowed");else for(var i=n.fold(function(t,e,n){if(!t.isEmpty()&&e&&e.hasCompleteView())return[e.getCompleteView().getQuery()];var r=[];return e&&(r=r.concat(e.getQueryViews().map(function(t){return t.getQuery()}))),z(n,function(t,e){r=r.concat(e)}),r}),o=0;o<i.length;++o){var s=i[o];this.listenProvider_.stopListening(ue.queryForListening_(s),this.tagForQuery_(s))}return e},ue.prototype.createListenerForView_=function(t){var e=this,n=t.getQuery(),r=this.tagForQuery_(n);return{hashFn:function(){return(t.getServerCache()||gr.EMPTY_NODE).hash()},onComplete:function(t){return"ok"===t?r?e.applyTaggedListenComplete(n.path,r):e.applyListenComplete(n.path):(t=function(t,e){var n="Unknown Error";return"too_big"===t?n="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===t?n="Client doesn't have permission to access the desired data.":"unavailable"===t&&(n="The service is unavailable"),n=new Error(t+" at "+e.path.toString()+": "+n),n.code=t.toUpperCase(),n}(t,n),e.removeEventRegistration(n,null,t))}}},ue.makeQueryKey_=function(t){return t.path.toString()+"$"+t.queryIdentifier()},ue.parseQueryKey_=function(t){var e=t.indexOf("$");return Ke(-1!==e&&e<t.length-1,"Bad queryKey."),{queryId:t.substr(e+1),path:new qn(t.substr(0,e))}},ue.prototype.queryKeyForTag_=function(t){return this.tagToQueryMap.get(t)},ue.prototype.tagForQuery_=function(t){return t=ue.makeQueryKey_(t),this.queryToTagMap.get(t)},ue.getNextQueryTag_=function(){return ue.nextQueryTag_++},ue.prototype.applyTaggedOperation_=function(t,e){var n=this.syncPointTree_.get(t);return Ke(n,"Missing sync point for query tag that we're tracking"),t=this.pendingWriteTree_.childWrites(t),n.applyOperation(e,t,null)},ue.prototype.applyOperationToSyncPoints_=function(t){return this.applyOperationHelper_(t,this.syncPointTree_,null,this.pendingWriteTree_.childWrites(qn.Empty))},ue.prototype.applyOperationHelper_=function(t,e,n,r){if(t.path.isEmpty())return this.applyOperationDescendantsHelper_(t,e,n,r);var i=e.get(qn.Empty);null==n&&null!=i&&(n=i.getCompleteServerCache(qn.Empty));var o=[],s=t.path.getFront(),a=t.operationForChild(s),h=e.children.get(s);return h&&a&&(e=n?n.getImmediateChild(s):null,s=r.child(s),o=o.concat(this.applyOperationHelper_(a,h,e,s))),i&&(o=o.concat(i.applyOperation(t,r,n))),o},ue.prototype.applyOperationDescendantsHelper_=function(t,e,n,r){var i=this,o=e.get(qn.Empty);null==n&&null!=o&&(n=o.getCompleteServerCache(qn.Empty));var s=[];return e.children.inorderTraversal(function(e,o){var a=n?n.getImmediateChild(e):null,h=r.child(e);e=t.operationForChild(e);e&&(s=s.concat(i.applyOperationDescendantsHelper_(e,o,a,h)))}),o&&(s=s.concat(o.applyOperation(t,r,n))),s},ue.nextQueryTag_=1,ue),hi=(ce.prototype.getNode=function(t){return this.rootNode_.getChild(t)},ce.prototype.updateSnapshot=function(t,e){this.rootNode_=this.rootNode_.updateChild(t,e)},ce),li=(pe.prototype.incrementCounter=function(t,e){void 0===e&&(e=1),m(this.counters_,t)||(this.counters_[t]=0),this.counters_[t]+=e},pe.prototype.get=function(){return u(this.counters_)},pe),ui=(de.getCollection=function(t){return t=t.toString(),this.collections_[t]||(this.collections_[t]=new li),this.collections_[t]},de.getOrCreateReporter=function(t,e){return t=t.toString(),this.reporters_[t]||(this.reporters_[t]=e()),this.reporters_[t]},de.collections_={},de.reporters_={},de),ci=(fe.prototype.get=function(){var t=this.collection_.get(),e=Be({},t);return this.last_&&z(this.last_,function(t,n){e[t]=e[t]-n}),this.last_=t,e},fe),pi=(_e.prototype.includeStat=function(t){this.statsToReport_[t]=!0},_e.prototype.reportStats_=function(){var t=this,e=this.statsListener_.get(),n={},r=!1;z(e,function(e,i){0<i&&m(t.statsToReport_,e)&&(n[e]=i,r=!0)}),r&&this.server_.reportStats(n),G(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},_e),di=(ye.prototype.queueEvents=function(t){for(var e=null,n=0;n<t.length;n++){var r=t[n],i=r.getPath();null===e||i.equals(e.getPath())||(this.eventLists_.push(e),e=null),null===e&&(e=new fi(i)),e.add(r)}e&&this.eventLists_.push(e)},ye.prototype.raiseEventsAtPath=function(t,e){this.queueEvents(e),this.raiseQueuedEventsMatchingPredicate_(function(e){return e.equals(t)})},ye.prototype.raiseEventsForChangedPath=function(t,e){this.queueEvents(e),this.raiseQueuedEventsMatchingPredicate_(function(e){return e.contains(t)||t.contains(e)})},ye.prototype.raiseQueuedEventsMatchingPredicate_=function(t){this.recursionDepth_++;for(var e=!0,n=0;n<this.eventLists_.length;n++){var r=this.eventLists_[n];r&&(t(r.getPath())?(this.eventLists_[n].raise(),this.eventLists_[n]=null):e=!1)}e&&(this.eventLists_=[]),this.recursionDepth_--},ye),fi=(ge.prototype.add=function(t){this.events_.push(t)},ge.prototype.raise=function(){for(var t=0;t<this.events_.length;t++){var e,n=this.events_[t];null!==n&&(this.events_[t]=null,e=n.getEventRunner(),Dn&&xn("event: "+n.toString()),Y(e))}},ge.prototype.getPath=function(){return this.path_},ge);ve.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(Array.isArray(this.listeners_[t]))for(var r=a(this.listeners_[t]),i=0;i<r.length;i++)r[i].callback.apply(r[i].context,e)},ve.prototype.on=function(t,e,n){this.validateEventType_(t),this.listeners_[t]=this.listeners_[t]||[],this.listeners_[t].push({callback:e,context:n}),t=this.getInitialEvent(t),t&&e.apply(n,t)},ve.prototype.off=function(t,e,n){this.validateEventType_(t);for(var r=this.listeners_[t]||[],i=0;i<r.length;i++)if(r[i].callback===e&&(!n||n===r[i].context))return void r.splice(i,1)},ve.prototype.validateEventType_=function(t){Ke(this.allowedEvents_.find(function(e){return e===t}),"Unknown event: "+t)},er=ve;var _i,yi,gi=(n(me,_i=er),me.getInstance=function(){return new me},me.prototype.getInitialEvent=function(t){return Ke("visible"===t,"Unknown event type: "+t),[this.visible_]},me),vi=(n(Ce,yi=er),Ce.getInstance=function(){return new Ce},Ce.prototype.getInitialEvent=function(t){return Ke("online"===t,"Unknown event type: "+t),[this.online_]},Ce.prototype.currentlyOnline=function(){return this.online_},Ce),mi=(Ee.prototype.closeAfter=function(t,e){this.closeAfterResponse=t,this.onClose=e,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},Ee.prototype.handleResponse=function(t,e){var n=this;this.pendingResponses[t]=e;for(var r=this;this.pendingResponses[this.currentResponseNum]&&"break"!==function(){var t=r.pendingResponses[r.currentResponseNum];delete r.pendingResponses[r.currentResponseNum];for(var e=0;e<t.length;++e)!function(e){t[e]&&Y(function(){n.onMessage_(t[e])})}(e);if(r.currentResponseNum===r.closeAfterResponse)return r.onClose&&(r.onClose(),r.onClose=null),"break";r.currentResponseNum++}(););},Ee),Ci="pLPCommand",Ei="pRTLPCB",wi=(we.prototype.open=function(t,e){var n,r,i,o=this;this.curSegmentNum=0,this.onDisconnect_=e,this.myPacketOrderer=new mi(t),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(function(){o.log_("Timed out trying to connect."),o.onClosed_(),o.connectTimeoutTimer_=null},Math.floor(3e4)),n=function(){var t;o.isClosed_||(o.scriptTagHolder=new bi(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=s(t,5),r=n[0],i=n[1],a=n[2];if(n[3],n[4],o.incrementIncomingBytes_(t),o.scriptTagHolder)if(o.connectTimeoutTimer_&&(clearTimeout(o.connectTimeoutTimer_),o.connectTimeoutTimer_=null),o.everConnected_=!0,"start"===r)o.id=i,o.password=a;else{if("close"!==r)throw new Error("Unrecognized command received: "+r);i?(o.scriptTagHolder.sendNewPolls=!1,o.myPacketOrderer.closeAfter(i,function(){o.onClosed_()})):o.onClosed_()}},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=s(t,2),r=n[0];n=n[1];o.incrementIncomingBytes_(t),o.myPacketOrderer.handleResponse(r,n)},function(){o.onClosed_()},o.urlFn),(t={start:"t"}).ser=Math.floor(1e8*Math.random()),o.scriptTagHolder.uniqueCallbackIdentifier&&(t.cb=o.scriptTagHolder.uniqueCallbackIdentifier),t.v="5",o.transportSessionId&&(t.s=o.transportSessionId),o.lastSessionId&&(t.ls=o.lastSessionId),o.applicationId&&(t.p=o.applicationId),"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf(Vn)&&(t.r="f"),t=o.urlFn(t),o.log_("Connecting via long-poll to "+t),o.scriptTagHolder.addTag(t,function(){}))},"complete"===document.readyState?n():(r=!1,i=function(){document.body?r||(r=!0,n()):setTimeout(i,Math.floor(10))},document.addEventListener?(document.addEventListener("DOMContentLoaded",i,!1),window.addEventListener("load",i,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&i()}),window.attachEvent("onload",i)))},we.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},we.forceAllow=function(){we.forceAllow_=!0},we.forceDisallow=function(){we.forceDisallow_=!0},we.isAvailable=function(){return!!we.forceAllow_||!(we.forceDisallow_||"undefined"==typeof document||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI)},we.prototype.markConnectionHealthy=function(){},we.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},we.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},we.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},we.prototype.send=function(t){t=g(t),this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);t=function(t){return t=h(t),Ge.encodeByteArray(t,!0)}(t);for(var e=B(t,1840),n=0;n<e.length;n++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,e.length,e[n]),this.curSegmentNum++},we.prototype.addDisconnectPingFrame=function(t,e){this.myDisconnFrame=document.createElement("iframe");var n={dframe:"t"};n.id=t,n.pw=e,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)},we.prototype.incrementIncomingBytes_=function(t){t=g(t).length,this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)},we),bi=(be.createIFrame_=function(){var t=document.createElement("iframe");if(t.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(t);try{t.contentWindow.document||xn("No IE domain setting required")}catch(n){var e=document.domain;t.src="javascript:void((function(){document.open();document.domain='"+e+"';document.close();})())"}return t.contentDocument?t.doc=t.contentDocument:t.contentWindow?t.doc=t.contentWindow.document:t.document&&(t.doc=t.document),t},be.prototype.close=function(){var t=this;this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(function(){null!==t.myIFrame&&(document.body.removeChild(t.myIFrame),t.myIFrame=null)},Math.floor(0)));var e=this.onDisconnect;e&&(this.onDisconnect=null,e())},be.prototype.startLongPoll=function(t,e){for(this.myID=t,this.myPW=e,this.alive=!0;this.newRequest_(););},be.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(0<this.pendingSegs.length?2:1)){this.currentSerial++;var t={};t.id=this.myID,t.pw=this.myPW,t.ser=this.currentSerial;t=this.urlFn(t);for(var e="",n=0;0<this.pendingSegs.length&&this.pendingSegs[0].d.length+30+e.length<=1870;){var r=this.pendingSegs.shift();e=e+"&seg"+n+"="+r.seg+"&ts"+n+"="+r.ts+"&d"+n+"="+r.d;n++}return t+=e,this.addLongPollTag_(t,this.currentSerial),!0}return!1},be.prototype.enqueueSegment=function(t,e,n){this.pendingSegs.push({seg:t,ts:e,d:n}),this.alive&&this.newRequest_()},be.prototype.addLongPollTag_=function(t,e){function n(){r.outstandingRequests.delete(e),r.newRequest_()}var r=this;this.outstandingRequests.add(e);var i=setTimeout(n,Math.floor(25e3));this.addTag(t,function(){clearTimeout(i),n()})},be.prototype.addTag=function(t,e){var n=this;setTimeout(function(){try{if(!n.sendNewPolls)return;var r=n.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=t,r.onload=r.onreadystatechange=function(){var t=r.readyState;t&&"loaded"!==t&&"complete"!==t||(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),e())},r.onerror=function(){xn("Long-poll script failed to load: "+t),n.sendNewPolls=!1,n.close()},n.myIFrame.doc.body.appendChild(r)}catch(t){}},Math.floor(1))},be),Si="",Ti=null;"undefined"!=typeof MozWebSocket?Ti=MozWebSocket:"undefined"!=typeof WebSocket&&(Ti=WebSocket);var Ii=(Te.connectionURL_=function(t,e,n){var r={v:"5"}
;return"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf(Vn)&&(r.r="f"),e&&(r.s=e),n&&(r.ls=n),t.connectionURL(Hn,r)},Te.prototype.open=function(t,e){var n,r=this;this.onDisconnect=e,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Tn.set("previous_websocket_failure",!0);try{d()||(n={headers:{"X-Firebase-GMPID":this.applicationId||""}},this.mySock=new Ti(this.connURL,[],n))}catch(e){return this.log_("Error instantiating WebSocket."),t=e.message||e.data,t&&this.log_(t),void this.onClosed_()}this.mySock.onopen=function(){r.log_("Websocket connected."),r.everConnected_=!0},this.mySock.onclose=function(){r.log_("Websocket connection was disconnected."),r.mySock=null,r.onClosed_()},this.mySock.onmessage=function(t){r.handleIncomingFrame(t)},this.mySock.onerror=function(t){r.log_("WebSocket error.  Closing connection."),t=t.message||t.data,t&&r.log_(t),r.onClosed_()}},Te.prototype.start=function(){},Te.forceDisallow=function(){Te.forceDisallow_=!0},Te.isAvailable=function(){var t,e=!1;return"undefined"!=typeof navigator&&navigator.userAgent&&(t=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/))&&1<t.length&&parseFloat(t[1])<4.4&&(e=!0),!e&&null!==Ti&&!Te.forceDisallow_},Te.previouslyFailed=function(){return Tn.isInMemoryStorage||!0===Tn.get("previous_websocket_failure")},Te.prototype.markConnectionHealthy=function(){Tn.remove("previous_websocket_failure")},Te.prototype.appendFrame_=function(t){this.frames.push(t),this.frames.length===this.totalFrames&&(t=this.frames.join(""),this.frames=null,t=y(t),this.onMessage(t))},Te.prototype.handleNewFrameCount_=function(t){this.totalFrames=t,this.frames=[]},Te.prototype.extractFrameCount_=function(t){if(Ke(null===this.frames,"We already have a frame buffer"),t.length<=6){var e=Number(t);if(!isNaN(e))return this.handleNewFrameCount_(e),null}return this.handleNewFrameCount_(1),t},Te.prototype.handleIncomingFrame=function(t){null!==this.mySock&&(t=t.data,this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),null!==this.frames?this.appendFrame_(t):null!==(t=this.extractFrameCount_(t))&&this.appendFrame_(t))},Te.prototype.send=function(t){this.resetKeepAlive(),t=g(t),this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);var e=B(t,16384);1<e.length&&this.sendString_(String(e.length));for(var n=0;n<e.length;n++)this.sendString_(e[n])},Te.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},Te.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},Te.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},Te.prototype.resetKeepAlive=function(){var t=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(function(){t.mySock&&t.sendString_("0"),t.resetKeepAlive()},Math.floor(45e3))},Te.prototype.sendString_=function(t){try{this.mySock.send(t)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},Te.responsesRequiredToBeHealthy=2,Te.healthyTimeout=3e4,Te),Ni=(Object.defineProperty(Ie,"ALL_TRANSPORTS",{get:function(){return[wi,Ii]},enumerable:!1,configurable:!0}),Ie.prototype.initTransports_=function(t){var e,n,r=Ii&&Ii.isAvailable(),i=r&&!Ii.previouslyFailed();if(t.webSocketOnly&&(r||U("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Ii];else{var s=this.transports_=[];try{for(var a=o(Ie.ALL_TRANSPORTS),h=a.next();!h.done;h=a.next()){var l=h.value;l&&l.isAvailable()&&s.push(l)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}}},Ie.prototype.initialTransport=function(){if(0<this.transports_.length)return this.transports_[0];throw new Error("No transports available")},Ie.prototype.upgradeTransport=function(){return 1<this.transports_.length?this.transports_[1]:null},Ie),Ri=(Ne.prototype.start_=function(){var t=this,e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,void 0,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(function(){t.conn_&&t.conn_.open(n,r)},Math.floor(0)),e=e.healthyTimeout||0,0<e&&(this.healthyTimeout_=G(function(){t.healthyTimeout_=null,t.isHealthy_||(t.conn_&&102400<t.conn_.bytesReceived?(t.log_("Connection exceeded healthy timeout but has received "+t.conn_.bytesReceived+" bytes.  Marking connection healthy."),t.isHealthy_=!0,t.conn_.markConnectionHealthy()):t.conn_&&10240<t.conn_.bytesSent?t.log_("Connection exceeded healthy timeout but has sent "+t.conn_.bytesSent+" bytes.  Leaving connection alive."):(t.log_("Closing unhealthy connection after timeout."),t.close()))},Math.floor(e)))},Ne.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},Ne.prototype.disconnReceiver_=function(t){var e=this;return function(n){t===e.conn_?e.onConnectionLost_(n):t===e.secondaryConn_?(e.log_("Secondary connection lost."),e.onSecondaryConnectionLost_()):e.log_("closing an old connection")}},Ne.prototype.connReceiver_=function(t){var e=this;return function(n){2!==e.state_&&(t===e.rx_?e.onPrimaryMessageReceived_(n):t===e.secondaryConn_?e.onSecondaryMessageReceived_(n):e.log_("message on old connection"))}},Ne.prototype.sendRequest=function(t){t={t:"d",d:t},this.sendData_(t)},Ne.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},Ne.prototype.onSecondaryControl_=function(t){"t"in t&&("a"===(t=t.t)?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_()))},Ne.prototype.onSecondaryMessageReceived_=function(t){var e=j("t",t);t=j("d",t);if("c"===e)this.onSecondaryControl_(t);else{if("d"!==e)throw new Error("Unknown protocol layer: "+e);this.pendingDataMessages.push(t)}},Ne.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},Ne.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},Ne.prototype.onPrimaryMessageReceived_=function(t){var e=j("t",t);t=j("d",t);"c"===e?this.onControl_(t):"d"===e&&this.onDataMessage_(t)},Ne.prototype.onDataMessage_=function(t){this.onPrimaryResponse_(),this.onMessage_(t)},Ne.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},Ne.prototype.onControl_=function(t){var e=j("t",t);if("d"in t)if(t=t.d,"h"===e)this.onHandshake_(t);else if("n"===e){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var n=0;n<this.pendingDataMessages.length;++n)this.onDataMessage_(this.pendingDataMessages[n]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===e?this.onConnectionShutdown_(t):"r"===e?this.onReset_(t):"e"===e?Q("Server Error: "+t):"o"===e?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Q("Unknown control packet command: "+e)},Ne.prototype.onHandshake_=function(t){var e=t.ts,n=t.v,r=t.h;this.sessionId=t.s,this.repoInfo_.updateHost(r),0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,e),"5"!==n&&U("Protocol version mismatch detected"),this.tryStartUpgrade_())},Ne.prototype.tryStartUpgrade_=function(){var t=this.transportManager_.upgradeTransport();t&&this.startUpgrade_(t)},Ne.prototype.startUpgrade_=function(t){var e=this;this.secondaryConn_=new t(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.sessionId),this.secondaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.secondaryConn_);t=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,t),G(function(){e.secondaryConn_&&(e.log_("Timed out trying to upgrade."),e.secondaryConn_.close())},Math.floor(6e4))},Ne.prototype.onReset_=function(t){this.log_("Reset packet received.  New host: "+t),this.repoInfo_.updateHost(t),1===this.state_?this.close():(this.closeConnections_(),this.start_())},Ne.prototype.onConnectionEstablished_=function(t,e){var n=this;this.log_("Realtime connection established."),this.conn_=t,this.state_=1,this.onReady_&&(this.onReady_(e,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):G(function(){n.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))},Ne.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},Ne.prototype.onSecondaryConnectionLost_=function(){var t=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==t&&this.rx_!==t||this.close()},Ne.prototype.onConnectionLost_=function(t){this.conn_=null,t||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Tn.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},Ne.prototype.onConnectionShutdown_=function(t){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(t),this.onKill_=null),this.onDisconnect_=null,this.close()},Ne.prototype.sendData_=function(t){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(t)},Ne.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},Ne.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},Ne);Re.prototype.put=function(t,e,n,r){},Re.prototype.merge=function(t,e,n,r){},Re.prototype.refreshAuthToken=function(t){},Re.prototype.onDisconnectPut=function(t,e,n){},Re.prototype.onDisconnectMerge=function(t,e,n){},Re.prototype.onDisconnectCancel=function(t,e){},Re.prototype.reportStats=function(t){},er=Re;var Pi,Di,Oi,xi=1e3,ki=3e5,Ai=(n(Pe,Pi=er),Pe.prototype.sendRequest=function(t,e,n){var r=++this.requestNumber_;e={r:r,a:t,b:e};this.log_(g(e)),Ke(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(e),n&&(this.requestCBHash_[r]=n)},Pe.prototype.listen=function(t,e,n,r){var i=t.queryIdentifier(),o=t.path.toString();this.log_("Listen called for "+o+" "+i),this.listens.has(o)||this.listens.set(o,new Map),Ke(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),"listen() called for non-default but complete query"),Ke(!this.listens.get(o).has(i),"listen() called twice for same path/queryId."),n={onComplete:r,hashFn:e,query:t,tag:n},this.listens.get(o).set(i,n),this.connected_&&this.sendListen_(n)},Pe.prototype.sendListen_=function(t){var e=this,n=t.query,r=n.path.toString(),i=n.queryIdentifier();this.log_("Listen on "+r+" for "+i);var o={p:r};t.tag&&(o.q=n.queryObject(),o.t=t.tag),o.h=t.hashFn(),this.sendRequest("q",o,function(o){var s=o.d,a=o.s;Pe.warnOnListenWarnings_(s,n),(e.listens.get(r)&&e.listens.get(r).get(i))===t&&(e.log_("listen response",o),"ok"!==a&&e.removeListen_(r,i),t.onComplete&&t.onComplete(a,s))})},Pe.warnOnListenWarnings_=function(t,e){t&&"object"==typeof t&&m(t,"w")&&(t=C(t,"w"),Array.isArray(t)&&~t.indexOf("no_index")&&(t='".indexOn": "'+e.getQueryParams().getIndex().toString()+'"',e=e.path.toString(),U("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+t+" at "+e+" to your security rules for better performance.")))},Pe.prototype.refreshAuthToken=function(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},function(){}),this.reduceReconnectDelayIfAdminCredential_(t)},Pe.prototype.reduceReconnectDelayIfAdminCredential_=function(t){(t&&40===t.length||function(t){return t=v(t).claims,"object"==typeof t&&!0===t.admin}(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},Pe.prototype.tryAuth=function(){var t,e,n,r=this;this.connected_&&this.authToken_&&(e=function(t){return t=v(t).claims,!!t&&"object"==typeof t&&t.hasOwnProperty("iat")}(t=this.authToken_)?"auth":"gauth",n={cred:t},null===this.authOverride_?n.noauth=!0:"object"==typeof this.authOverride_&&(n.authvar=this.authOverride_),this.sendRequest(e,n,function(e){var n=e.s;e=e.d||"error";r.authToken_===t&&("ok"===n?r.invalidAuthTokenCount_=0:r.onAuthRevoked_(n,e))}))},Pe.prototype.unlisten=function(t,e){var n=t.path.toString(),r=t.queryIdentifier();this.log_("Unlisten called for "+n+" "+r),Ke(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(n,r)&&this.connected_&&this.sendUnlisten_(n,r,t.queryObject(),e)},Pe.prototype.sendUnlisten_=function(t,e,n,r){this.log_("Unlisten on "+t+" for "+e),t={p:t},r&&(t.q=n,t.t=r),this.sendRequest("n",t)},Pe.prototype.onDisconnectPut=function(t,e,n){this.connected_?this.sendOnDisconnect_("o",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:e,onComplete:n})},Pe.prototype.onDisconnectMerge=function(t,e,n){this.connected_?this.sendOnDisconnect_("om",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:e,onComplete:n})},Pe.prototype.onDisconnectCancel=function(t,e){this.connected_?this.sendOnDisconnect_("oc",t,null,e):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:e})},Pe.prototype.sendOnDisconnect_=function(t,e,n,r){n={p:e,d:n},this.log_("onDisconnect "+t,n),this.sendRequest(t,n,function(t){r&&setTimeout(function(){r(t.s,t.d)},Math.floor(0))})},Pe.prototype.put=function(t,e,n,r){this.putInternal("p",t,e,n,r)},Pe.prototype.merge=function(t,e,n,r){this.putInternal("m",t,e,n,r)},Pe.prototype.putInternal=function(t,e,n,r,i){n={p:e,d:n},void 0!==i&&(n.h=i),this.outstandingPuts_.push({action:t,request:n,onComplete:r}),this.outstandingPutCount_++,r=this.outstandingPuts_.length-1,this.connected_?this.sendPut_(r):this.log_("Buffering put: "+e)},Pe.prototype.sendPut_=function(t){var e=this,n=this.outstandingPuts_[t].action,r=this.outstandingPuts_[t].request,i=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(n,r,function(r){e.log_(n+" response",r),delete e.outstandingPuts_[t],e.outstandingPutCount_--,0===e.outstandingPutCount_&&(e.outstandingPuts_=[]),i&&i(r.s,r.d)})},Pe.prototype.reportStats=function(t){var e=this;this.connected_&&(t={c:t},this.log_("reportStats",t),this.sendRequest("s",t,function(t){"ok"!==t.s&&(t=t.d,e.log_("reportStats","Error sending stats: "+t))}))},Pe.prototype.onDataMessage_=function(t){if("r"in t){this.log_("from server: "+g(t));var e=t.r,n=this.requestCBHash_[e];n&&(delete this.requestCBHash_[e],n(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}},Pe.prototype.onDataPush_=function(t,e){this.log_("handleServerMessage",t,e),"d"===t?this.onDataUpdate_(e.p,e.d,!1,e.t):"m"===t?this.onDataUpdate_(e.p,e.d,!0,e.t):"c"===t?this.onListenRevoked_(e.p,e.q):"ac"===t?this.onAuthRevoked_(e.s,e.d):"sd"===t?this.onSecurityDebugPacket_(e):Q("Unrecognized action received from server: "+g(t)+"\nAre you using the latest client?")},Pe.prototype.onReady_=function(t,e){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(t),this.lastSessionId=e,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},Pe.prototype.scheduleConnect_=function(t){var e=this;Ke(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(function(){e.establishConnectionTimer_=null,e.establishConnection_()},Math.floor(t))},Pe.prototype.onVisible_=function(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=xi,this.realtime_||this.scheduleConnect_(0)),this.visible_=t},Pe.prototype.onOnline_=function(t){t?(this.log_("Browser went online."),this.reconnectDelay_=xi,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},Pe.prototype.onRealtimeDisconnect_=function(){var t;this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()&&(this.visible_?this.lastConnectionEstablishedTime_&&(3e4<(new Date).getTime()-this.lastConnectionEstablishedTime_&&(this.reconnectDelay_=xi),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime()),t=(new Date).getTime()-this.lastConnectionAttemptTime_,t=Math.max(0,this.reconnectDelay_-t),t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)),this.onConnectStatus_(!1)},Pe.prototype.establishConnection_=function(){var t,e,n,r,i,o,s,a,h,l,u=this;this.shouldReconnect_()&&(this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null,t=this.onDataMessage_.bind(this),e=this.onReady_.bind(this),n=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+Pe.nextConnectionId_++,o=(i=this).lastSessionId,s=!1,a=null,h=function(){a?a.close():(s=!0,n())},this.realtime_={close:h,sendRequest:function(t){Ke(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(t)}},l=this.forceTokenRefresh_,this.forceTokenRefresh_=!1,this.authTokenProvider_.getToken(l).then(function(h){s?xn("getToken() completed but was canceled"):(xn("getToken() completed. Creating connection."),i.authToken_=h&&h.accessToken,a=new Ri(r,i.repoInfo_,i.applicationId_,t,e,n,function(t){U(t+" ("+i.repoInfo_.toString()+")"),i.interrupt("server_kill")},o))}).then(null,function(t){i.log_("Failed to get token: "+t),s||(u.repoInfo_.nodeAdmin&&U(t),h())}))},Pe.prototype.interrupt=function(t){xn("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},Pe.prototype.resume=function(t){xn("Resuming connection for reason: "+t),delete this.interruptReasons_[t],E(this.interruptReasons_)&&(this.reconnectDelay_=xi,this.realtime_||this.scheduleConnect_(0))},Pe.prototype.handleTimestamp_=function(t){t-=(new Date).getTime(),this.onServerInfoUpdate_({serverTimeOffset:t})},Pe.prototype.cancelSentTransactions_=function(){for(var t=0;t<this.outstandingPuts_.length;t++){var e=this.outstandingPuts_[t];e&&"h"in e.request&&e.queued&&(e.onComplete&&e.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},Pe.prototype.onListenRevoked_=function(t,e){e=e?e.map(function(t){return Mn(t)}).join("$"):"default",e=this.removeListen_(t,e),e&&e.onComplete&&e.onComplete("permission_denied")},Pe.prototype.removeListen_=function(t,e){var n,r=new qn(t).toString();return this.listens.has(r)?(n=(t=this.listens.get(r)).get(e),t.delete(e),0===t.size&&this.listens.delete(r)):n=void 0,n},Pe.prototype.onAuthRevoked_=function(t,e){xn("Auth token revoked: "+t+"/"+e),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==t&&"permission_denied"!==t||(this.invalidAuthTokenCount_++,3<=this.invalidAuthTokenCount_&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},Pe.prototype.onSecurityDebugPacket_=function(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace("\n","\nFIREBASE: "))},Pe.prototype.restoreState_=function(){var t,e,n,r;this.tryAuth();try{for(var i=o(this.listens.values()),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(a.values())),l=h.next();!l.done;l=h.next()){var u=l.value;this.sendListen_(u)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}for(var c=0;c<this.outstandingPuts_.length;c++)this.outstandingPuts_[c]&&this.sendPut_(c);for(;this.onDisconnectRequestQueue_.length;){var p=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(p.action,p.pathString,p.data,p.onComplete)}},Pe.prototype.sendConnectStats_=function(){var t={};t["sdk.js."+Si.replace(/\./g,"-")]=1,p()?t["framework.cordova"]=1:"object"==typeof navigator&&"ReactNative"===navigator.product&&(t["framework.reactnative"]=1),this.reportStats(t)},Pe.prototype.shouldReconnect_=function(){var t=vi.getInstance().currentlyOnline();return E(this.interruptReasons_)&&t},Pe.nextPersistentConnectionId_=0,Pe.nextConnectionId_=0,Pe),Fi=(n(De,Di=er),De.prototype.reportStats=function(t){throw new Error("Method not implemented.")},De.getListenId_=function(t,e){return void 0!==e?"tag$"+e:(Ke(t.getQueryParams().isDefault(),"should have a tag if it's not a default query."),t.path.toString())},De.prototype.listen=function(t,e,n,r){var i=this,o=t.path.toString();this.log_("Listen called for "+o+" "+t.queryIdentifier());var s=De.getListenId_(t,n),a={};this.listens_[s]=a,t=t.getQueryParams().toRestQueryStringParameters(),this.restRequest_(o+".json",t,function(t,e){404===t&&(t=e=null),null===t&&i.onDataUpdate_(o,e,!1,n),C(i.listens_,s)===a&&r(t?401===t?"permission_denied":"rest_error:"+t:"ok",null)})},De.prototype.unlisten=function(t,e){e=De.getListenId_(t,e),delete this.listens_[e]},De.prototype.refreshAuthToken=function(t){},De.prototype.restRequest_=function(t,e,n){var r=this;void 0===e&&(e={}),e.format="export",this.authTokenProvider_.getToken(!1).then(function(i){i=i&&i.accessToken,i&&(e.auth=i);var o=(r.repoInfo_.secure?"https://":"http://")+r.repoInfo_.host+t+"?ns="+r.repoInfo_.namespace+function(t){for(var e=[],n=0,r=Object.entries(t);n<r.length;n++){var i=r[n];!function(t,n){Array.isArray(n)?n.forEach(function(n){e.push(encodeURIComponent(t)+"="+encodeURIComponent(n))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(n))}(i[0],i[1])}return e.length?"&"+e.join("&"):""}(e);r.log_("Sending REST request for "+o);var s=new XMLHttpRequest;s.onreadystatechange=function(){if(n&&4===s.readyState){r.log_("REST Response for "+o+" received. status:",s.status,"response:",s.responseText);var t=null;if(200<=s.status&&s.status<300){try{t=y(s.responseText)}catch(t){U("Failed to parse JSON response for "+o+": "+s.responseText)}n(null,t)}else 401!==s.status&&404!==s.status&&U("Got unsuccessful REST response for "+o+" Status: "+s.status),n(s.status);n=null}},s.open("GET",o,!0),s.send()})},De),Li="repo_interrupt",Mi=(Oe.prototype.start=function(){var t=this;if(this.stats_=ui.getCollection(this.repoInfo_),this.forceRestClient_||0<=("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i))this.server_=new Fi(this.repoInfo_,this.onDataUpdate_.bind(this),this.authTokenProvider_),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{var e=this.app.options.databaseAuthVariableOverride;if(null!=e){if("object"!=typeof e)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{g(e)}catch(e){throw new Error("Invalid authOverride provided: "+e)}}this.persistentConnection_=new Ai(this.repoInfo_,this.app.options.appId,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),this.authTokenProvider_,e),this.server_=this.persistentConnection_}this.authTokenProvider_.addTokenChangeListener(function(e){t.server_.refreshAuthToken(e)}),this.statsReporter_=ui.getOrCreateReporter(this.repoInfo_,function(){return new pi(t.stats_,t.server_)}),this.transactionsInit_(),this.infoData_=new hi,this.infoSyncTree_=new ai({startListening:function(e,n,r,i){var o=[],s=t.infoData_.getNode(e.path);return s.isEmpty()||(o=t.infoSyncTree_.applyServerOverwrite(e.path,s),setTimeout(function(){i("ok")},0)),o},stopListening:function(){}}),this.updateInfo_("connected",!1),this.serverSyncTree_=new ai({startListening:function(e,n,r,i){return t.server_.listen(e,r,n,function(n,r){r=i(n,r),t.eventQueue_.raiseEventsForChangedPath(e.path,r)}),[]},stopListening:function(e,n){t.server_.unlisten(e,n)}})},Oe.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},Oe.prototype.name=function(){return this.repoInfo_.namespace},Oe.prototype.serverTime=function(){var t=this.infoData_.getNode(new qn(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t},Oe.prototype.generateServerValues=function(){return(t=(t={timestamp:this.serverTime()})||{}).timestamp=t.timestamp||(new Date).getTime(),t;var t},Oe.prototype.onDataUpdate_=function(t,e,n,r){this.dataUpdateCount++;var i=new qn(t);e=this.interceptServerDataCallback_?this.interceptServerDataCallback_(t,e):e;var o,s=[];t=i;0<(s=r?n?(o=w(e,function(t){return Pt(t)}),this.serverSyncTree_.applyTaggedQueryMerge(i,o,r)):(o=Pt(e),this.serverSyncTree_.applyTaggedQueryOverwrite(i,o,r)):n?(n=w(e,function(t){return Pt(t)}),this.serverSyncTree_.applyServerMerge(i,n)):(e=Pt(e),this.serverSyncTree_.applyServerOverwrite(i,e))).length&&(t=this.rerunTransactions_(i)),this.eventQueue_.raiseEventsForChangedPath(t,s)},Oe.prototype.interceptServerData_=function(t){this.interceptServerDataCallback_=t},Oe.prototype.onConnectStatus_=function(t){this.updateInfo_("connected",t),!1===t&&this.runOnDisconnectEvents_()},Oe.prototype.onServerInfoUpdate_=function(t){var e=this;z(t,function(t,n){e.updateInfo_(t,n)})},Oe.prototype.updateInfo_=function(t,e){t=new qn("/.info/"+t),e=Pt(e),this.infoData_.updateSnapshot(t,e),e=this.infoSyncTree_.applyServerOverwrite(t,e),this.eventQueue_.raiseEventsForChangedPath(t,e)},Oe.prototype.getNextWriteId_=function(){return this.nextWriteId_++},Oe.prototype.setWithPriority=function(t,e,n,r){var i=this;this.log_("set",{path:t.toString(),value:e,priority:n});var o=this.generateServerValues(),s=(e=Pt(e,n),n=this.serverSyncTree_.calcCompleteEventCache(t),o=Ut(e,n,o),this.getNextWriteId_());o=this.serverSyncTree_.applyUserOverwrite(t,o,s,!0);this.eventQueue_.queueEvents(o),this.server_.put(t.toString(),e.val(!0),function(e,n){var o="ok"===e;o||U("set at "+t+" failed: "+e),o=i.serverSyncTree_.ackUserWrite(s,!o),i.eventQueue_.raiseEventsForChangedPath(t,o),i.callOnCompleteCallback(r,e,n)}),e=this.abortTransactions_(t),this.rerunTransactions_(e),this.eventQueue_.raiseEventsForChangedPath(e,[])},Oe.prototype.update=function(t,e,n){var r=this;this.log_("update",{path:t.toString(),value:e});var i,o,s=!0,a=this.generateServerValues(),h={};z(e,function(e,n){s=!1,h[e]=qt(t.child(e),Pt(n),r.serverSyncTree_,a)}),s?(xn("update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(n,"ok")):(i=this.getNextWriteId_(),o=this.serverSyncTree_.applyUserMerge(t,h,i),this.eventQueue_.queueEvents(o),this.server_.merge(t.toString(),e,function(e,o){var s="ok"===e;s||U("update at "+t+" failed: "+e);var a=r.serverSyncTree_.ackUserWrite(i,!s);s=0<a.length?r.rerunTransactions_(t):t;r.eventQueue_.raiseEventsForChangedPath(s,a),r.callOnCompleteCallback(n,e,o)}),z(e,function(e){e=r.abortTransactions_(t.child(e)),r.rerunTransactions_(e)}),this.eventQueue_.raiseEventsForChangedPath(t,[]))},Oe.prototype.runOnDisconnectEvents_=function(){var t=this;this.log_("onDisconnectEvents");var e=this.generateServerValues(),n=new Mr;this.onDisconnect_.forEachTree(qn.Empty,function(r,i){i=qt(r,i,t.serverSyncTree_,e),n.remember(r,i)});var r=[];n.forEachTree(qn.Empty,function(e,n){r=r.concat(t.serverSyncTree_.applyServerOverwrite(e,n)),e=t.abortTransactions_(e),t.rerunTransactions_(e)}),this.onDisconnect_=new Mr,this.eventQueue_.raiseEventsForChangedPath(qn.Empty,r)},Oe.prototype.onDisconnectCancel=function(t,e){var n=this;this.server_.onDisconnectCancel(t.toString(),function(r,i){"ok"===r&&n.onDisconnect_.forget(t),n.callOnCompleteCallback(e,r,i)})},Oe.prototype.onDisconnectSet=function(t,e,n){var r=this,i=Pt(e);this.server_.onDisconnectPut(t.toString(),i.val(!0),function(e,o){"ok"===e&&r.onDisconnect_.remember(t,i),r.callOnCompleteCallback(n,e,o)})},Oe.prototype.onDisconnectSetWithPriority=function(t,e,n,r){var i=this,o=Pt(e,n);this.server_.onDisconnectPut(t.toString(),o.val(!0),function(e,n){"ok"===e&&i.onDisconnect_.remember(t,o),i.callOnCompleteCallback(r,e,n)})},Oe.prototype.onDisconnectUpdate=function(t,e,n){var r=this;if(E(e))return xn("onDisconnect().update() called with empty data.  Don't do anything."),void this.callOnCompleteCallback(n,"ok");this.server_.onDisconnectMerge(t.toString(),e,function(i,o){"ok"===i&&z(e,function(e,n){n=Pt(n),r.onDisconnect_.remember(t.child(e),n)}),r.callOnCompleteCallback(n,i,o)})},Oe.prototype.addEventCallbackForQuery=function(t,e){e=(".info"===t.path.getFront()?this.infoSyncTree_:this.serverSyncTree_).addEventRegistration(t,e),this.eventQueue_.raiseEventsAtPath(t.path,e)},Oe.prototype.removeEventCallbackForQuery=function(t,e){e=(".info"===t.path.getFront()?this.infoSyncTree_:this.serverSyncTree_).removeEventRegistration(t,e),this.eventQueue_.raiseEventsAtPath(t.path,e)},Oe.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt(Li)},Oe.prototype.resume=function(){this.persistentConnection_&&this.persistentConnection_.resume(Li)},Oe.prototype.stats=function(t){var e;void 0===t&&(t=!1),"undefined"!=typeof console&&(t=t?(this.statsListener_||(this.statsListener_=new ci(this.stats_)),this.statsListener_.get()):this.stats_.get(),e=Object.keys(t).reduce(function(t,e){return Math.max(e.length,t)},0),z(t,function(t,n){for(var r=t,i=t.length;i<e+2;i++)r+=" ";console.log(r+n)}))},Oe.prototype.statsIncrementCounter=function(t){this.stats_.incrementCounter(t),this.statsReporter_.includeStat(t)},Oe.prototype.log_=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=""
;this.persistentConnection_&&(n=this.persistentConnection_.id+":"),xn.apply(void 0,a([n],t))},Oe.prototype.callOnCompleteCallback=function(t,e,n){t&&Y(function(){var r,i;"ok"===e?t(null):(i=r=(e||"error").toUpperCase(),n&&(i+=": "+n),(i=new Error(i)).code=r,t(i))})},Object.defineProperty(Oe.prototype,"database",{get:function(){return this.__database||(this.__database=new Gi(this))},enumerable:!1,configurable:!0}),Oe),Wi=(xe.prototype.getStartPost=function(){return this.startPost_},xe.prototype.getEndPost=function(){return this.endPost_},xe.prototype.matches=function(t){return this.index_.compare(this.getStartPost(),t)<=0&&this.index_.compare(t,this.getEndPost())<=0},xe.prototype.updateChild=function(t,e,n,r,i,o){return this.matches(new tr(e,n))||(n=gr.EMPTY_NODE),this.indexedFilter_.updateChild(t,e,n,r,i,o)},xe.prototype.updateFullNode=function(t,e,n){e.isLeafNode()&&(e=gr.EMPTY_NODE);var r=(r=e.withIndex(this.index_)).updatePriority(gr.EMPTY_NODE),i=this;return e.forEachChild(or,function(t,e){i.matches(new tr(t,e))||(r=r.updateImmediateChild(t,gr.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(t,r,n)},xe.prototype.updatePriority=function(t,e){return t},xe.prototype.filtersNodes=function(){return!0},xe.prototype.getIndexedFilter=function(){return this.indexedFilter_},xe.prototype.getIndex=function(){return this.index_},xe.getStartPost_=function(t){if(t.hasStart()){var e=t.getIndexStartName();return t.getIndex().makePost(t.getIndexStartValue(),e)}return t.getIndex().minPost()},xe.getEndPost_=function(t){if(t.hasEnd()){var e=t.getIndexEndName();return t.getIndex().makePost(t.getIndexEndValue(),e)}return t.getIndex().maxPost()},xe),Qi=(ke.prototype.updateChild=function(t,e,n,r,i,o){return this.rangedFilter_.matches(new tr(e,n))||(n=gr.EMPTY_NODE),t.getImmediateChild(e).equals(n)?t:t.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(t,e,n,r,i,o):this.fullLimitUpdateChild_(t,e,n,i,o)},ke.prototype.updateFullNode=function(t,e,n){var r;if(e.isLeafNode()||e.isEmpty())r=gr.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<e.numChildren()&&e.isIndexed(this.index_)){r=gr.EMPTY_NODE.withIndex(this.index_);var i=void 0;i=this.reverse_?e.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):e.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var o=0;i.hasNext()&&o<this.limit_;){var s=i.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),s)<=0:this.index_.compare(s,this.rangedFilter_.getEndPost())<=0))break;r=r.updateImmediateChild(s.name,s.node),o++}}else{r=(r=e.withIndex(this.index_)).updatePriority(gr.EMPTY_NODE);var a,h=void 0,l=void 0,u=void 0;i=void 0;u=this.reverse_?(i=r.getReverseIterator(this.index_),h=this.rangedFilter_.getEndPost(),l=this.rangedFilter_.getStartPost(),a=this.index_.getCompare(),function(t,e){return a(e,t)}):(i=r.getIterator(this.index_),h=this.rangedFilter_.getStartPost(),l=this.rangedFilter_.getEndPost(),this.index_.getCompare());o=0;for(var c=!1;i.hasNext();)s=i.getNext(),!c&&u(h,s)<=0&&(c=!0),c&&o<this.limit_&&u(s,l)<=0?o++:r=r.updateImmediateChild(s.name,gr.EMPTY_NODE)}return this.rangedFilter_.getIndexedFilter().updateFullNode(t,r,n)},ke.prototype.updatePriority=function(t,e){return t},ke.prototype.filtersNodes=function(){return!0},ke.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},ke.prototype.getIndex=function(){return this.index_},ke.prototype.fullLimitUpdateChild_=function(t,e,n,r,i){var o,s;s=this.reverse_?(o=this.index_.getCompare(),function(t,e){return o(e,t)}):this.index_.getCompare();var a=t;Ke(a.numChildren()===this.limit_,"");var h=new tr(e,n),l=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(h);if(a.hasChild(e)){for(var c=a.getImmediateChild(e),p=r.getChildAfterChild(this.index_,l,this.reverse_);null!=p&&(p.name===e||a.hasChild(p.name));)p=r.getChildAfterChild(this.index_,p,this.reverse_);var d=null==p?1:s(p,h);return u&&!n.isEmpty()&&0<=d?(null!=i&&i.trackChildChange(Yr.childChangedChange(e,n,c)),a.updateImmediateChild(e,n)):(null!=i&&i.trackChildChange(Yr.childRemovedChange(e,c)),c=a.updateImmediateChild(e,gr.EMPTY_NODE),null!=p&&this.rangedFilter_.matches(p)?(null!=i&&i.trackChildChange(Yr.childAddedChange(p.name,p.node)),c.updateImmediateChild(p.name,p.node)):c)}return!n.isEmpty()&&u&&0<=s(l,h)?(null!=i&&(i.trackChildChange(Yr.childRemovedChange(l.name,l.node)),i.trackChildChange(Yr.childAddedChange(e,n))),a.updateImmediateChild(e,n).updateImmediateChild(l.name,gr.EMPTY_NODE)):t},ke),qi=(Ae.prototype.hasStart=function(){return this.startSet_},Ae.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:this.viewFrom_===Ae.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT},Ae.prototype.getIndexStartValue=function(){return Ke(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},Ae.prototype.getIndexStartName=function(){return Ke(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:An},Ae.prototype.hasEnd=function(){return this.endSet_},Ae.prototype.getIndexEndValue=function(){return Ke(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},Ae.prototype.getIndexEndName=function(){return Ke(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Fn},Ae.prototype.hasLimit=function(){return this.limitSet_},Ae.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},Ae.prototype.getLimit=function(){return Ke(this.limitSet_,"Only valid if limit has been set"),this.limit_},Ae.prototype.getIndex=function(){return this.index_},Ae.prototype.copy_=function(){var t=new Ae;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t},Ae.prototype.limit=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_="",e},Ae.prototype.limitToFirst=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_=Ae.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT,e},Ae.prototype.limitToLast=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_=Ae.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_RIGHT,e},Ae.prototype.startAt=function(t,e){var n=this.copy_();return n.startSet_=!0,void 0===t&&(t=null),n.indexStartValue_=t,null!=e?(n.startNameSet_=!0,n.indexStartName_=e):(n.startNameSet_=!1,n.indexStartName_=""),n},Ae.prototype.endAt=function(t,e){var n=this.copy_();return n.endSet_=!0,void 0===t&&(t=null),n.indexEndValue_=t,void 0!==e?(n.endNameSet_=!0,n.indexEndName_=e):(n.endNameSet_=!1,n.indexEndName_=""),n},Ae.prototype.orderBy=function(t){var e=this.copy_();return e.index_=t,e},Ae.prototype.getQueryObject=function(){var t,e=Ae.WIRE_PROTOCOL_CONSTANTS_,n={};return this.startSet_&&(n[e.INDEX_START_VALUE]=this.indexStartValue_,this.startNameSet_&&(n[e.INDEX_START_NAME]=this.indexStartName_)),this.endSet_&&(n[e.INDEX_END_VALUE]=this.indexEndValue_,this.endNameSet_&&(n[e.INDEX_END_NAME]=this.indexEndName_)),this.limitSet_&&(n[e.LIMIT]=this.limit_,""===(t=this.viewFrom_)&&(t=this.isViewFromLeft()?e.VIEW_FROM_LEFT:e.VIEW_FROM_RIGHT),n[e.VIEW_FROM]=t),this.index_!==or&&(n[e.INDEX]=this.index_.toString()),n},Ae.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},Ae.prototype.isDefault=function(){return this.loadsAllData()&&this.index_===or},Ae.prototype.getNodeFilter=function(){return this.loadsAllData()?new Gr(this.getIndex()):new(this.hasLimit()?Qi:Wi)(this)},Ae.prototype.toRestQueryStringParameters=function(){var t,e=Ae.REST_QUERY_CONSTANTS_,n={};return this.isDefault()||(t=this.index_===or?e.PRIORITY_INDEX:this.index_===Sr?e.VALUE_INDEX:this.index_===nr?e.KEY_INDEX:(Ke(this.index_ instanceof Tr,"Unrecognized index type!"),this.index_.toString()),n[e.ORDER_BY]=g(t),this.startSet_&&(n[e.START_AT]=g(this.indexStartValue_),this.startNameSet_&&(n[e.START_AT]+=","+g(this.indexStartName_))),this.endSet_&&(n[e.END_AT]=g(this.indexEndValue_),this.endNameSet_&&(n[e.END_AT]+=","+g(this.indexEndName_))),this.limitSet_&&(this.isViewFromLeft()?n[e.LIMIT_TO_FIRST]=this.limit_:n[e.LIMIT_TO_LAST]=this.limit_)),n},Ae.WIRE_PROTOCOL_CONSTANTS_={INDEX_START_VALUE:"sp",INDEX_START_NAME:"sn",INDEX_END_VALUE:"ep",INDEX_END_NAME:"en",LIMIT:"l",VIEW_FROM:"vf",VIEW_FROM_LEFT:"l",VIEW_FROM_RIGHT:"r",INDEX:"i"},Ae.REST_QUERY_CONSTANTS_={ORDER_BY:"orderBy",PRIORITY_INDEX:"$priority",VALUE_INDEX:"$value",KEY_INDEX:"$key",START_AT:"startAt",END_AT:"endAt",LIMIT_TO_FIRST:"limitToFirst",LIMIT_TO_LAST:"limitToLast"},Ae.DEFAULT=new Ae,Ae),Ui=(n(Fe,Oi=Or),Fe.prototype.getKey=function(){return S("Reference.key",0,0,arguments.length),this.path.isEmpty()?null:this.path.getBack()},Fe.prototype.child=function(t){var e,n,r,i;return S("Reference.child",1,1,arguments.length),"number"==typeof t?t=String(t):t instanceof qn||(null===this.path.getFront()?(e="Reference.child",i=!(n=1),r=(r=t)&&r.replace(/^\/*\.info(\/|$)/,"/"),ht(e,n,r,i)):ht("Reference.child",1,t,!1)),new Fe(this.repo,this.path.child(t))},Fe.prototype.getParent=function(){S("Reference.parent",0,0,arguments.length);var t=this.path.parent();return null===t?null:new Fe(this.repo,t)},Fe.prototype.getRoot=function(){S("Reference.root",0,0,arguments.length);for(var t=this;null!==t.getParent();)t=t.getParent();return t},Fe.prototype.databaseProp=function(){return this.repo.database},Fe.prototype.set=function(t,e){S("Reference.set",1,2,arguments.length),lt("Reference.set",this.path),rt("Reference.set",1,t,this.path,!1),I("Reference.set",2,e,!0);var n=new Xe;return this.repo.setWithPriority(this.path,t,null,n.wrapCallback(e)),n.promise},Fe.prototype.update=function(t,e){if(S("Reference.update",1,2,arguments.length),lt("Reference.update",this.path),Array.isArray(t)){for(var n={},r=0;r<t.length;++r)n[""+r]=t[r];t=n,U("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}it("Reference.update",1,t,this.path,!1),I("Reference.update",2,e,!0);var i=new Xe;return this.repo.update(this.path,t,i.wrapCallback(e)),i.promise},Fe.prototype.setWithPriority=function(t,e,n){if(S("Reference.setWithPriority",2,3,arguments.length),lt("Reference.setWithPriority",this.path),rt("Reference.setWithPriority",1,t,this.path,!1),ot("Reference.setWithPriority",2,e,!1),I("Reference.setWithPriority",3,n,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.setWithPriority failed: "+this.getKey()+" is a read-only object.";var r=new Xe;return this.repo.setWithPriority(this.path,t,e,r.wrapCallback(n)),r.promise},Fe.prototype.remove=function(t){return S("Reference.remove",0,1,arguments.length),lt("Reference.remove",this.path),I("Reference.remove",1,t,!0),this.set(null,t)},Fe.prototype.transaction=function(t,e,n){if(S("Reference.transaction",1,3,arguments.length),lt("Reference.transaction",this.path),I("Reference.transaction",1,t,!1),I("Reference.transaction",2,e,!0),function(t,e,n,r){if((!r||void 0!==n)&&"boolean"!=typeof n)throw new Error(T(t,e,r)+"must be a boolean.")}("Reference.transaction",3,n,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.transaction failed: "+this.getKey()+" is a read-only object.";void 0===n&&(n=!0);var r=new Xe;return"function"==typeof e&&r.promise.catch(function(){}),this.repo.startTransaction(this.path,t,function(t,n,i){t?r.reject(t):r.resolve(new Jn(n,i)),"function"==typeof e&&e(t,n,i)},n),r.promise},Fe.prototype.setPriority=function(t,e){S("Reference.setPriority",1,2,arguments.length),lt("Reference.setPriority",this.path),ot("Reference.setPriority",1,t,!1),I("Reference.setPriority",2,e,!0);var n=new Xe;return this.repo.setWithPriority(this.path.child(".priority"),t,null,n.wrapCallback(e)),n.promise},Fe.prototype.push=function(t,e){S("Reference.push",0,2,arguments.length),lt("Reference.push",this.path),rt("Reference.push",1,t,this.path,!0),I("Reference.push",2,e,!0);var n=this.repo.serverTime(),r=Zn(n),i=(n=this.child(r),this.child(r));t=null!=t?n.set(t,e).then(function(){return i}):Promise.resolve(i);return n.then=t.then.bind(t),n.catch=t.then.bind(t,void 0),"function"==typeof e&&t.catch(function(){}),n},Fe.prototype.onDisconnect=function(){return lt("Reference.onDisconnect",this.path),new $n(this.repo,this.path)},Object.defineProperty(Fe.prototype,"database",{get:function(){return this.databaseProp()},enumerable:!1,configurable:!0}),Object.defineProperty(Fe.prototype,"key",{get:function(){return this.getKey()},enumerable:!1,configurable:!0}),Object.defineProperty(Fe.prototype,"parent",{get:function(){return this.getParent()},enumerable:!1,configurable:!0}),Object.defineProperty(Fe.prototype,"root",{get:function(){return this.getRoot()},enumerable:!1,configurable:!0}),Fe);Or.__referenceConstructor=Ui,ri.__referenceConstructor=Ui;var Vi,Hi=function(){this.children={},this.childCount=0,this.value=null},ji=(Le.prototype.subTree=function(t){for(var e=t instanceof qn?t:new qn(t),n=this,r=e.getFront();null!==r;)n=new Le(r,n,C(n.node_.children,r)||new Hi),r=(e=e.popFront()).getFront();return n},Le.prototype.getValue=function(){return this.node_.value},Le.prototype.setValue=function(t){Ke(void 0!==t,"Cannot set value to undefined"),this.node_.value=t,this.updateParents_()},Le.prototype.clear=function(){this.node_.value=null,this.node_.children={},this.node_.childCount=0,this.updateParents_()},Le.prototype.hasChildren=function(){return 0<this.node_.childCount},Le.prototype.isEmpty=function(){return null===this.getValue()&&!this.hasChildren()},Le.prototype.forEachChild=function(t){var e=this;z(this.node_.children,function(n,r){t(new Le(n,e,r))})},Le.prototype.forEachDescendant=function(t,e,n){e&&!n&&t(this),this.forEachChild(function(e){e.forEachDescendant(t,!0,n)}),e&&n&&t(this)},Le.prototype.forEachAncestor=function(t,e){for(var n=e?this:this.parent();null!==n;){if(t(n))return!0;n=n.parent()}return!1},Le.prototype.forEachImmediateDescendantWithValue=function(t){this.forEachChild(function(e){null!==e.getValue()?t(e):e.forEachImmediateDescendantWithValue(t)})},Le.prototype.path=function(){return new qn(null===this.parent_?this.name_:this.parent_.path()+"/"+this.name_)},Le.prototype.name=function(){return this.name_},Le.prototype.parent=function(){return this.parent_},Le.prototype.updateParents_=function(){null!==this.parent_&&this.parent_.updateChild_(this.name_,this)},Le.prototype.updateChild_=function(t,e){var n=e.isEmpty(),r=m(this.node_.children,t);n&&r?(delete this.node_.children[t],this.node_.childCount--,this.updateParents_()):n||r||(this.node_.children[t]=e.node_,this.node_.childCount++,this.updateParents_())},Le);(er=Vi=Vi||{})[er.RUN=0]="RUN",er[er.SENT=1]="SENT",er[er.COMPLETED=2]="COMPLETED",er[er.SENT_NEEDS_ABORT=3]="SENT_NEEDS_ABORT",er[er.NEEDS_ABORT=4]="NEEDS_ABORT",Mi.MAX_TRANSACTION_RETRIES_=25,Mi.prototype.transactionsInit_=function(){this.transactionQueueTree_=new ji},Mi.prototype.startTransaction=function(t,e,n,r){function i(){}this.log_("transaction on "+t);var o=new Ui(this,t);o.on("value",i);var s={path:t,update:e,onComplete:n,status:null,order:Rn(),applyLocally:r,retryCount:0,unwatcher:function(){o.off("value",i)},abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null};e=this.getLatestState_(t);s.currentInputSnapshot=e;var a;n=s.update(e.val());void 0===n?(s.unwatcher(),s.currentOutputSnapshotRaw=null,s.currentOutputSnapshotResolved=null,s.onComplete&&(a=new Ir(s.currentInputSnapshot,new Ui(this,s.path),or),s.onComplete(null,!1,a))):(Xn("transaction failed: Data returned ",n,s.path),s.status=Vi.RUN,(a=(r=this.transactionQueueTree_.subTree(t)).getValue()||[]).push(s),r.setValue(a),r=void 0,"object"==typeof n&&null!==n&&m(n,".priority")?(r=C(n,".priority"),Ke(nt(r),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):r=(this.serverSyncTree_.calcCompleteEventCache(t)||gr.EMPTY_NODE).getPriority().val(),a=this.generateServerValues(),r=Pt(n,r),a=Ut(r,e,a),s.currentOutputSnapshotRaw=r,s.currentOutputSnapshotResolved=a,s.currentWriteId=this.getNextWriteId_(),s=this.serverSyncTree_.applyUserOverwrite(t,a,s.currentWriteId,s.applyLocally),this.eventQueue_.raiseEventsForChangedPath(t,s),this.sendReadyTransactions_())},Mi.prototype.getLatestState_=function(t,e){return this.serverSyncTree_.calcCompleteEventCache(t,e)||gr.EMPTY_NODE},Mi.prototype.sendReadyTransactions_=function(t){var e,n=this;void 0===t&&(t=this.transactionQueueTree_),t||this.pruneCompletedTransactionsBelowNode_(t),null!==t.getValue()?(e=this.buildTransactionQueue_(t),Ke(0<e.length,"Sending zero length transaction queue"),e.every(function(t){return t.status===Vi.RUN})&&this.sendTransactionQueue_(t.path(),e)):t.hasChildren()&&t.forEachChild(function(t){n.sendReadyTransactions_(t)})},Mi.prototype.sendTransactionQueue_=function(t,e){for(var n=this,r=e.map(function(t){return t.currentWriteId}),i=this.getLatestState_(t,r),o=i,s=(r=i.hash(),0);s<e.length;s++){var a=e[s];Ke(a.status===Vi.RUN,"tryToSendTransactionQueue_: items in queue should all be run."),a.status=Vi.SENT,a.retryCount++;var h=qn.relativePath(t,a.path);o=o.updateChild(h,a.currentOutputSnapshotRaw)}i=o.val(!0);var l=t;this.server_.put(l.toString(),i,function(r){n.log_("transaction put response",{path:l.toString(),status:r});var i=[];if("ok"===r){for(var o,s,a=[],h=0;h<e.length;h++)e[h].status=Vi.COMPLETED,i=i.concat(n.serverSyncTree_.ackUserWrite(e[h].currentWriteId)),e[h].onComplete&&(o=e[h].currentOutputSnapshotResolved,s=new Ui(n,e[h].path),s=new Ir(o,s,or),a.push(e[h].onComplete.bind(null,null,!0,s))),e[h].unwatcher();for(n.pruneCompletedTransactionsBelowNode_(n.transactionQueueTree_.subTree(t)),n.sendReadyTransactions_(),n.eventQueue_.raiseEventsForChangedPath(t,i),h=0;h<a.length;h++)Y(a[h])}else{if("datastale"===r)for(h=0;h<e.length;h++)e[h].status===Vi.SENT_NEEDS_ABORT?e[h].status=Vi.NEEDS_ABORT:e[h].status=Vi.RUN;else for(U("transaction at "+l.toString()+" failed: "+r),h=0;h<e.length;h++)e[h].status=Vi.NEEDS_ABORT,e[h].abortReason=r;n.rerunTransactions_(t)}},r)},Mi.prototype.rerunTransactions_=function(t){var e=this.getAncestorTransactionNode_(t);t=e.path(),e=this.buildTransactionQueue_(e);return this.rerunTransactionQueue_(e,t),t},Mi.prototype.rerunTransactionQueue_=function(t,e){if(0!==t.length){for(var n=[],r=[],i=t.filter(function(t){return t.status===Vi.RUN}).map(function(t){return t.currentWriteId}),o=0;o<t.length;o++){var s,a,h,l=t[o],u=qn.relativePath(e,l.path),c=!1,p=void 0;Ke(null!==u,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===Vi.NEEDS_ABORT?(c=!0,p=l.abortReason,r=r.concat(this.serverSyncTree_.ackUserWrite(l.currentWriteId,!0))):l.status===Vi.RUN&&(r=l.retryCount>=Mi.MAX_TRANSACTION_RETRIES_?(c=!0,p="maxretry",r.concat(this.serverSyncTree_.ackUserWrite(l.currentWriteId,!0))):(s=this.getLatestState_(l.path,i),l.currentInputSnapshot=s,void 0!==(h=t[o].update(s.val()))?(Xn("transaction failed: Data returned ",h,l.path),a=Pt(h),"object"==typeof h&&null!=h&&m(h,".priority")||(a=a.updatePriority(s.getPriority())),u=l.currentWriteId,h=this.generateServerValues(),h=Ut(a,s,h),l.currentOutputSnapshotRaw=a,l.currentOutputSnapshotResolved=h,l.currentWriteId=this.getNextWriteId_(),i.splice(i.indexOf(u),1),(r=r.concat(this.serverSyncTree_.applyUserOverwrite(l.path,h,l.currentWriteId,l.applyLocally))).concat(this.serverSyncTree_.ackUserWrite(u,!0))):(c=!0,p="nodata",r.concat(this.serverSyncTree_.ackUserWrite(l.currentWriteId,!0))))),this.eventQueue_.raiseEventsForChangedPath(e,r),r=[],c&&(t[o].status=Vi.COMPLETED,l=t[o].unwatcher,setTimeout(l,Math.floor(0)),t[o].onComplete&&("nodata"===p?(c=new Ui(this,t[o].path),l=t[o].currentInputSnapshot,c=new Ir(l,c,or),n.push(t[o].onComplete.bind(null,null,!1,c))):n.push(t[o].onComplete.bind(null,new Error(p),!1,null))))}for(this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_),o=0;o<n.length;o++)Y(n[o]);this.sendReadyTransactions_()}},Mi.prototype.getAncestorTransactionNode_=function(t){for(var e=this.transactionQueueTree_,n=t.getFront();null!==n&&null===e.getValue();)e=e.subTree(n),n=(t=t.popFront()).getFront();return e},Mi.prototype.buildTransactionQueue_=function(t){var e=[];return this.aggregateTransactionQueuesForNode_(t,e),e.sort(function(t,e){return t.order-e.order}),e},Mi.prototype.aggregateTransactionQueuesForNode_=function(t,e){var n=this,r=t.getValue();if(null!==r)for(var i=0;i<r.length;i++)e.push(r[i]);t.forEachChild(function(t){n.aggregateTransactionQueuesForNode_(t,e)})},Mi.prototype.pruneCompletedTransactionsBelowNode_=function(t){var e=this,n=t.getValue();if(n){for(var r=0,i=0;i<n.length;i++)n[i].status!==Vi.COMPLETED&&(n[r]=n[i],r++);n.length=r,t.setValue(0<n.length?n:null)}t.forEachChild(function(t){e.pruneCompletedTransactionsBelowNode_(t)})},Mi.prototype.abortTransactions_=function(t){var e=this,n=this.getAncestorTransactionNode_(t).path();t=this.transactionQueueTree_.subTree(t);return t.forEachAncestor(function(t){e.abortTransactionsOnNode_(t)}),this.abortTransactionsOnNode_(t),t.forEachDescendant(function(t){e.abortTransactionsOnNode_(t)}),n},Mi.prototype.abortTransactionsOnNode_=function(t){var e=t.getValue();if(null!==e){for(var n=[],r=[],i=-1,o=0;o<e.length;o++)e[o].status===Vi.SENT_NEEDS_ABORT||(e[o].status===Vi.SENT?(Ke(i===o-1,"All SENT items should be at beginning of queue."),e[i=o].status=Vi.SENT_NEEDS_ABORT,e[o].abortReason="set"):(Ke(e[o].status===Vi.RUN,"Unexpected transaction status in abort"),e[o].unwatcher(),r=r.concat(this.serverSyncTree_.ackUserWrite(e[o].currentWriteId,!0)),e[o].onComplete&&n.push(e[o].onComplete.bind(null,new Error("set"),!1,null))));for(-1===i?t.setValue(null):e.length=i+1,this.eventQueue_.raiseEventsForChangedPath(t.path(),r),o=0;o<n.length;o++)Y(n[o])}};var Bi,zi=(Me.prototype.getToken=function(t){return this.auth_?this.auth_.getToken(t).catch(function(t){return t&&"auth/token-not-initialized"===t.code?(xn("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)}):Promise.resolve(null)},Me.prototype.addTokenChangeListener=function(t){this.auth_?this.auth_.addAuthTokenListener(t):(setTimeout(function(){return t(null)},0),this.authProvider_.get().then(function(e){return e.addAuthTokenListener(t)}))},Me.prototype.removeTokenChangeListener=function(t){this.authProvider_.get().then(function(e){return e.removeAuthTokenListener(t)})},Me.prototype.notifyForInvalidToken=function(){var t='Provided authentication credentials for the app named "'+this.app_.name+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.app_.options?t+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.app_.options?t+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':t+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',U(t)},Me),Ki=(We.prototype.getToken=function(t){return Promise.resolve({accessToken:We.EMULATOR_AUTH_TOKEN})},We.prototype.addTokenChangeListener=function(t){t(We.EMULATOR_AUTH_TOKEN)},We.prototype.removeTokenChangeListener=function(t){},We.prototype.notifyForInvalidToken=function(){},We.EMULATOR_AUTH_TOKEN="owner",We),Yi=(Qe.getInstance=function(){return Bi=Bi||new Qe},Qe.prototype.interrupt=function(){var t,e,n,r;try{for(var i=o(Object.keys(this.repos_)),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(Object.keys(this.repos_[a]))),l=h.next();!l.done;l=h.next()){var u=l.value;this.repos_[a][u].interrupt()}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},Qe.prototype.resume=function(){var t,e,n,r;try{for(var i=o(Object.keys(this.repos_)),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(Object.keys(this.repos_[a]))),l=h.next();!l.done;l=h.next()){var u=l.value;this.repos_[a][u].resume()}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},Qe.prototype.applyEmulatorSettings=function(t,e,n){t.repoInfo_=new Bn(e+":"+n,!1,t.repoInfo_.namespace,t.repoInfo_.webSocketOnly,t.repoInfo_.nodeAdmin,t.repoInfo_.persistenceKey,t.repoInfo_.includeNamespaceInQueryParams),t.repoInfo_.nodeAdmin&&(t.authTokenProvider_=new Ki)},Qe.prototype.databaseFromApp=function(t,e,n,r){var i=n||t.options.databaseURL;void 0===i&&(t.options.projectId||q("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),xn("Using default host for project ",t.options.projectId),i=t.options.projectId+"-default-rtdb.firebaseio.com");var o,s=Z(i,r),a=s.repoInfo;n=void 0;return"undefined"!=typeof process&&(n=process.env.FIREBASE_DATABASE_EMULATOR_HOST),n?(o=!0,i="http://"+n+"?ns="+a.namespace,a=(s=Z(i,r)).repoInfo):o=!s.repoInfo.secure,e=r&&o?new Ki:new zi(t,e),ut("Invalid Firebase Database URL",1,s),s.path.isEmpty()||q("Database URL must point to the root of a Firebase Database (not including a child path)."),this.createRepo(a,t,e).database},Qe.prototype.deleteRepo=function(t){var e=C(this.repos_,t.app.name);e&&C(e,t.key)===t||q("Database "+t.app.name+"("+t.repoInfo_+") has already been deleted."),t.interrupt(),delete e[t.key]},Qe.prototype.createRepo=function(t,e,n){var r=C(this.repos_,e.name);r||(r={},this.repos_[e.name]=r);var i=C(r,t.toURLString());return i&&q("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),i=new Mi(t,this.useRestClient_,e,n),r[t.toURLString()]=i},Qe.prototype.forceRestClient=function(t){this.useRestClient_=t},Qe),Gi=(Object.defineProperty(qe.prototype,"repo_",{get:function(){return this.instanceStarted_||(this.repoInternal_.start(),this.instanceStarted_=!0),this.repoInternal_},enumerable:!1,configurable:!0}),Object.defineProperty(qe.prototype,"root_",{get:function(){return this.rootInternal_||(this.rootInternal_=new Ui(this.repo_,qn.Empty)),this.rootInternal_},enumerable:!1,configurable:!0}),Object.defineProperty(qe.prototype,"app",{get:function(){return this.repo_.app},enumerable:!1,configurable:!0}),qe.prototype.useEmulator=function(t,e){this.checkDeleted_("useEmulator"),this.instanceStarted_?q("Cannot call useEmulator() after instance has already been initialized."):Yi.getInstance().applyEmulatorSettings(this.repoInternal_,t,e)},qe.prototype.ref=function(t){return this.checkDeleted_("ref"),S("database.ref",0,1,arguments.length),t instanceof Ui?this.refFromURL(t.toString()):void 0!==t?this.root_.child(t):this.root_},qe.prototype.refFromURL=function(t){var e="database.refFromURL";this.checkDeleted_(e),S(e,1,1,arguments.length);var n=Z(t,this.repo_.repoInfo_.nodeAdmin);return ut(e,1,n),t=n.repoInfo,t.isCustomHost()||t.host===this.repo_.repoInfo_.host||q(e+": Host name does not match the current database: (found "+t.host+" but expected "+this.repo_.repoInfo_.host+")"),this.ref(n.path.toString())},qe.prototype.checkDeleted_=function(t){null===this.repoInternal_&&q("Cannot call "+t+" on a deleted database.")},qe.prototype.goOffline=function(){S("database.goOffline",0,0,arguments.length),this.checkDeleted_("goOffline"),this.repo_.interrupt()},qe.prototype.goOnline=function(){S("database.goOnline",0,0,arguments.length),this.checkDeleted_("goOnline"),this.repo_.resume()},qe.ServerValue={TIMESTAMP:{".sv":"timestamp"},increment:function(t){return{".sv":{increment:t}}}},qe),Xi=Object.freeze({__proto__:null,forceLongPolling:function(){Ii.forceDisallow(),wi.forceAllow()},forceWebSockets:function(){wi.forceDisallow()},isWebSocketsAvailable:function(){return Ii.isAvailable()},setSecurityDebugCallback:function(t,e){t.repo.persistentConnection_.securityDebugCallback_=e},stats:function(t,e){t.repo.stats(e)},statsIncrementCounter:function(t,e){t.repo.statsIncrementCounter(e)},dataUpdateCount:function(t){return t.repo.dataUpdateCount},interceptServerData:function(t,e){return t.repo.interceptServerData_(e)},initStandalone:function(t){var e=t.app,n=t.url,r=t.version,i=t.customAuthImpl,o=t.namespace;t=void 0!==(t=t.nodeAdmin)&&t;return Se(r),(r=new Cn("auth-internal",new En("database-standalone"))).setComponent(new vn("auth-internal",function(){return i},"PRIVATE")),{instance:Yi.getInstance().databaseFromApp(e,r,n,t),namespace:o}}});er=Ai;Ai.prototype.simpleListen=function(t,e){this.sendRequest("q",{p:t},e)},Ai.prototype.echo=function(t,e){this.sendRequest("echo",{d:t},e)};var $i,Ji=Object.freeze({__proto__:null,DataConnection:er,RealTimeConnection:Ri,hijackHash:function(t){var e=Ai.prototype.put;return Ai.prototype.put=function(n,r,i,o){void 0!==o&&(o=t()),e.call(this,n,r,i,o)},function(){Ai.prototype.put=e}},ConnectionTarget:Bn,queryIdentifier:function(t){return t.queryIdentifier()},forceRestClient:function(t){Yi.getInstance().forceRestClient(t)}}),Zi=Gi.ServerValue;Se(($i=He.default).SDK_VERSION),$i.INTERNAL.registerComponent(new vn("database",function(t,e){var n=t.getProvider("app").getImmediate();t=t.getProvider("auth-internal");return Yi.getInstance().databaseFromApp(n,t,e)},"PUBLIC").setServiceProps({Reference:Ui,Query:Or,Database:Gi,DataSnapshot:Ir,enableLogging:W,INTERNAL:Xi,ServerValue:Zi,TEST_ACCESS:Ji}).setMultipleInstances(!0)),$i.registerVersion("@firebase/database","0.7.0")}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-database.js - be sure to load firebase-app.js first.")}});